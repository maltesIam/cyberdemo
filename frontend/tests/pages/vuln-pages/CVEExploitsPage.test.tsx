/**
 * CVEExploitsPage Tests - TDD
 *
 * Tests for the CVE Exploits nested page
 * - List of known exploits
 * - ExploitDB and GitHub PoC links
 * - Verification status badges
 * - Navigation
 */

import { describe, it, expect, beforeEach, vi } from "vitest";
import { render, screen, waitFor } from "@testing-library/react";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { MemoryRouter, Routes, Route } from "react-router-dom";
import { ToastProvider } from "../../../src/utils/toast";
import React from "react";
import { CVEExploitsPage } from "../../../src/pages/vuln-pages/CVEExploitsPage";

// ============================================================================
// Mock API Module
// ============================================================================

vi.mock("../../../src/services/api", () => ({
  getCVEExploits: vi.fn().mockResolvedValue({
    cve_id: "CVE-2024-0001",
    exploits: [
      {
        id: "exploit-001",
        source: "exploitdb",
        source_id: "EDB-51234",
        title: "Apache Log4j RCE Exploit PoC",
        url: "https://www.exploit-db.com/exploits/51234",
        author: "security_researcher",
        publish_date: "2024-01-12",
        verification_status: "verified",
        maturity: "functional",
      },
      {
        id: "exploit-002",
        source: "github",
        source_id: "gh-poc-log4j",
        title: "Log4Shell Exploitation Toolkit",
        url: "https://github.com/user/log4shell-poc",
        author: "pentester123",
        publish_date: "2024-01-11",
        verification_status: "unverified",
        maturity: "poc",
      },
      {
        id: "exploit-003",
        source: "nuclei",
        source_id: "nuclei-log4j-rce",
        title: "Nuclei Template - Log4j RCE Detection",
        url: "https://github.com/projectdiscovery/nuclei-templates/blob/main/cves/2024/CVE-2024-0001.yaml",
        author: "projectdiscovery",
        publish_date: "2024-01-13",
        verification_status: "verified",
        maturity: "weaponized",
      },
    ],
    total: 5,
    has_nuclei_template: true,
    exploit_maturity: "weaponized",
  }),
  getVulnerabilityDetail: vi.fn().mockResolvedValue({
    cve_id: "CVE-2024-0001",
    title: "Critical RCE Vulnerability",
  }),
}));

// ============================================================================
// Test Utilities
// ============================================================================

function createTestQueryClient() {
  return new QueryClient({
    defaultOptions: {
      queries: {
        retry: false,
        gcTime: 0,
      },
    },
  });
}

function renderWithRoute(initialRoute: string) {
  const queryClient = createTestQueryClient();
  return render(
    <QueryClientProvider client={queryClient}>
      <ToastProvider>
        <MemoryRouter initialEntries={[initialRoute]}>
          <Routes>
            <Route
              path="/vulnerabilities/cves/:cveId/exploits"
              element={<CVEExploitsPage />}
            />
          </Routes>
        </MemoryRouter>
      </ToastProvider>
    </QueryClientProvider>
  );
}

// ============================================================================
// CVEExploitsPage Tests
// ============================================================================

describe("CVEExploitsPage", () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe("Page Header", () => {
    it("should display page title with CVE ID", async () => {
      renderWithRoute("/vulnerabilities/cves/CVE-2024-0001/exploits");

      await waitFor(() => {
        expect(screen.getByText(/CVE-2024-0001/i)).toBeInTheDocument();
        const exploitTexts = screen.getAllByText(/Exploit/i);
        expect(exploitTexts.length).toBeGreaterThan(0);
      });
    });

    it("should display total exploits count", async () => {
      renderWithRoute("/vulnerabilities/cves/CVE-2024-0001/exploits");

      await waitFor(() => {
        const countElements = screen.getAllByText(/5/);
        expect(countElements.length).toBeGreaterThan(0);
      });
    });

    it("should display exploit maturity level", async () => {
      renderWithRoute("/vulnerabilities/cves/CVE-2024-0001/exploits");

      await waitFor(() => {
        const maturityElements = screen.getAllByText(/weaponized/i);
        expect(maturityElements.length).toBeGreaterThan(0);
      });
    });
  });

  describe("Exploits List", () => {
    it("should display exploit titles", async () => {
      renderWithRoute("/vulnerabilities/cves/CVE-2024-0001/exploits");

      await waitFor(() => {
        expect(
          screen.getByText(/Apache Log4j RCE Exploit PoC/i)
        ).toBeInTheDocument();
        expect(
          screen.getByText(/Log4Shell Exploitation Toolkit/i)
        ).toBeInTheDocument();
      });
    });

    it("should display exploit authors", async () => {
      renderWithRoute("/vulnerabilities/cves/CVE-2024-0001/exploits");

      await waitFor(() => {
        expect(screen.getByText(/security_researcher/i)).toBeInTheDocument();
        expect(screen.getByText(/pentester123/i)).toBeInTheDocument();
      });
    });

    it("should display publish dates", async () => {
      renderWithRoute("/vulnerabilities/cves/CVE-2024-0001/exploits");

      await waitFor(() => {
        expect(screen.getByText(/2024-01-12/)).toBeInTheDocument();
      });
    });
  });

  describe("Source Links", () => {
    it("should display ExploitDB link for exploitdb sources", async () => {
      renderWithRoute("/vulnerabilities/cves/CVE-2024-0001/exploits");

      await waitFor(() => {
        const exploitDbLink = screen.getByRole("link", { name: /EDB-51234/i });
        expect(exploitDbLink).toHaveAttribute(
          "href",
          "https://www.exploit-db.com/exploits/51234"
        );
      });
    });

    it("should display GitHub link for github sources", async () => {
      renderWithRoute("/vulnerabilities/cves/CVE-2024-0001/exploits");

      await waitFor(() => {
        const githubLink = screen.getByRole("link", {
          name: /Log4Shell Exploitation Toolkit/i,
        });
        expect(githubLink).toHaveAttribute(
          "href",
          "https://github.com/user/log4shell-poc"
        );
      });
    });

    it("should open links in new tab", async () => {
      renderWithRoute("/vulnerabilities/cves/CVE-2024-0001/exploits");

      await waitFor(() => {
        const links = screen.getAllByRole("link");
        const externalLinks = links.filter((link) =>
          link.getAttribute("href")?.startsWith("http")
        );
        externalLinks.forEach((link) => {
          expect(link).toHaveAttribute("target", "_blank");
        });
      });
    });
  });

  describe("Verification Status Badges", () => {
    it("should display verified badge", async () => {
      renderWithRoute("/vulnerabilities/cves/CVE-2024-0001/exploits");

      await waitFor(() => {
        const verifiedBadges = screen.getAllByText(/verified/i);
        expect(verifiedBadges.length).toBeGreaterThan(0);
      });
    });

    it("should display unverified badge", async () => {
      renderWithRoute("/vulnerabilities/cves/CVE-2024-0001/exploits");

      await waitFor(() => {
        expect(screen.getByText(/unverified/i)).toBeInTheDocument();
      });
    });
  });

  describe("Maturity Badges", () => {
    it("should display functional maturity badge", async () => {
      renderWithRoute("/vulnerabilities/cves/CVE-2024-0001/exploits");

      await waitFor(() => {
        expect(screen.getByText(/functional/i)).toBeInTheDocument();
      });
    });

    it("should display poc maturity badge", async () => {
      renderWithRoute("/vulnerabilities/cves/CVE-2024-0001/exploits");

      await waitFor(() => {
        const pocElements = screen.getAllByText(/poc/i);
        expect(pocElements.length).toBeGreaterThan(0);
      });
    });
  });

  describe("Nuclei Template Indicator", () => {
    it("should show Nuclei template available indicator", async () => {
      renderWithRoute("/vulnerabilities/cves/CVE-2024-0001/exploits");

      await waitFor(() => {
        const nucleiElements = screen.getAllByText(/Nuclei/i);
        expect(nucleiElements.length).toBeGreaterThan(0);
      });
    });
  });

  describe("Navigation", () => {
    it("should have breadcrumb navigation", async () => {
      renderWithRoute("/vulnerabilities/cves/CVE-2024-0001/exploits");

      await waitFor(() => {
        const breadcrumb = screen.getByRole("navigation", { name: /breadcrumb/i });
        expect(breadcrumb).toBeInTheDocument();
      });
    });

    it("should have link back to CVE detail", async () => {
      renderWithRoute("/vulnerabilities/cves/CVE-2024-0001/exploits");

      await waitFor(() => {
        const cveLink = screen.getByRole("link", { name: /CVE-2024-0001/i });
        expect(cveLink).toHaveAttribute(
          "href",
          "/vulnerabilities/cves/CVE-2024-0001"
        );
      });
    });
  });
});
