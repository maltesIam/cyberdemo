/**
 * VulnerabilityDashboard Tests - TDD
 *
 * Tests for Phase 4: Frontend Layout and Navigation
 * - VulnerabilityDashboard page
 * - useVulnerabilities hooks
 * - Sidebar integration
 */

import { describe, it, expect, beforeEach, vi } from "vitest";
import { render, screen, fireEvent, waitFor } from "@testing-library/react";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { BrowserRouter } from "react-router-dom";
import { ToastProvider } from "../src/utils/toast";

// ============================================================================
// Mock API Module
// ============================================================================

vi.mock("../src/services/api", () => ({
  getVulnerabilitySummary: vi.fn().mockResolvedValue({
    total_cves: 150,
    critical_count: 12,
    high_count: 35,
    medium_count: 68,
    low_count: 35,
    kev_count: 8,
    exploitable_count: 23,
    overdue_count: 5,
    remediated_count: 42,
    in_progress_count: 28,
    open_count: 80,
    ssvc_act: 10,
    ssvc_attend: 25,
    ssvc_track_star: 45,
    ssvc_track: 70,
    mttr_days: 4.2,
    sla_compliance_percent: 87.5,
  }),
  getVulnerabilities: vi.fn().mockResolvedValue({
    data: [
      {
        cve_id: "CVE-2024-0001",
        title: "Critical Remote Code Execution",
        cvss_v3_score: 9.8,
        epss_score: 0.972,
        severity: "Critical",
        is_kev: true,
        ssvc_decision: "Act",
        exploit_count: 5,
        remediation_status: "open",
      },
      {
        cve_id: "CVE-2024-0002",
        title: "SQL Injection Vulnerability",
        cvss_v3_score: 8.5,
        epss_score: 0.456,
        severity: "High",
        is_kev: false,
        ssvc_decision: "Attend",
        exploit_count: 2,
        remediation_status: "in_progress",
      },
    ],
    total: 150,
    page: 1,
    page_size: 20,
    total_pages: 8,
  }),
  // Visualization API mocks
  getVulnerabilityTerrain: vi.fn().mockResolvedValue({
    points: [
      { cve_id: "CVE-2024-0001", cvss_score: 9.8, epss_score: 0.972, severity: "Critical", is_kev: true, exploit_count: 5, x: 0, y: 0 },
      { cve_id: "CVE-2024-0002", cvss_score: 8.5, epss_score: 0.456, severity: "High", is_kev: false, exploit_count: 2, x: 1, y: 0 },
    ],
    grid_size: 10,
    max_cvss: 10,
    total_cves: 150,
  }),
  getVulnerabilityHeatmap: vi.fn().mockResolvedValue({
    days: [
      { date: "2024-01-01", count: 5, critical_count: 1, high_count: 2, medium_count: 1, low_count: 1 },
      { date: "2024-01-02", count: 3, critical_count: 0, high_count: 1, medium_count: 2, low_count: 0 },
    ],
    start_date: "2024-01-01",
    end_date: "2024-01-31",
    max_count: 10,
    total_cves: 150,
  }),
  getVulnerabilitySunburst: vi.fn().mockResolvedValue({
    root: {
      name: "CWE",
      value: 150,
      children: [
        { name: "Injection", value: 45, cwe_id: "CWE-74", severity_counts: { critical: 10, high: 15, medium: 15, low: 5 } },
        { name: "Auth", value: 35, cwe_id: "CWE-287", severity_counts: { critical: 5, high: 10, medium: 10, low: 10 } },
      ],
    },
    total_cves: 150,
    total_cwes: 25,
  }),
  getVulnerabilityBubbles: vi.fn().mockResolvedValue({
    bubbles: [
      { cve_id: "CVE-2024-0001", risk_score: 95, cvss_score: 9.8, epss_score: 0.972, severity: "Critical", is_kev: true, ssvc_decision: "Act", title: "RCE", affected_asset_count: 15 },
      { cve_id: "CVE-2024-0002", risk_score: 75, cvss_score: 8.5, epss_score: 0.456, severity: "High", is_kev: false, ssvc_decision: "Attend", title: "SQLi", affected_asset_count: 8 },
    ],
    total_cves: 150,
    severity_distribution: { critical: 12, high: 35, medium: 68, low: 35 },
  }),
  getRemediationFlow: vi.fn().mockResolvedValue({
    nodes: [
      { id: "discovered", name: "Discovered", count: 150 },
      { id: "triaged", name: "Triaged", count: 120 },
      { id: "in_progress", name: "In Progress", count: 28 },
      { id: "remediated", name: "Remediated", count: 42 },
    ],
    links: [
      { source: "discovered", target: "triaged", value: 120 },
      { source: "triaged", target: "in_progress", value: 28 },
      { source: "in_progress", target: "remediated", value: 42 },
    ],
    total_cves: 150,
    remediated_count: 42,
    in_progress_count: 28,
    open_count: 80,
  }),
}));

// ============================================================================
// Test Utilities
// ============================================================================

function createTestQueryClient() {
  return new QueryClient({
    defaultOptions: {
      queries: {
        retry: false,
        gcTime: 0,
      },
    },
  });
}

function renderWithProviders(component: React.ReactElement) {
  const queryClient = createTestQueryClient();
  return render(
    <QueryClientProvider client={queryClient}>
      <ToastProvider>
        <BrowserRouter>{component}</BrowserRouter>
      </ToastProvider>
    </QueryClientProvider>
  );
}

// ============================================================================
// VulnerabilityDashboard Page Tests
// ============================================================================

describe("VulnerabilityDashboard Page", () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe("Header Section", () => {
    it("should render page title 'Vulnerability Command Center'", async () => {
      // Import component dynamically to avoid issues with mocking
      const { VulnerabilityDashboard } = await import(
        "../src/pages/VulnerabilityDashboard"
      );

      renderWithProviders(<VulnerabilityDashboard />);

      await waitFor(() => {
        expect(screen.getByText(/Vulnerability Command Center/i)).toBeInTheDocument();
      });
    });

    it("should render bug/shield icon in header", async () => {
      const { VulnerabilityDashboard } = await import(
        "../src/pages/VulnerabilityDashboard"
      );

      const { container } = renderWithProviders(<VulnerabilityDashboard />);

      await waitFor(() => {
        const svg = container.querySelector("svg");
        expect(svg).toBeInTheDocument();
      });
    });

    it("should render refresh button", async () => {
      const { VulnerabilityDashboard } = await import(
        "../src/pages/VulnerabilityDashboard"
      );

      renderWithProviders(<VulnerabilityDashboard />);

      await waitFor(() => {
        const refreshButton = screen.getByRole("button", { name: /refresh/i });
        expect(refreshButton).toBeInTheDocument();
      });
    });

    it("should render export button", async () => {
      const { VulnerabilityDashboard } = await import(
        "../src/pages/VulnerabilityDashboard"
      );

      renderWithProviders(<VulnerabilityDashboard />);

      await waitFor(() => {
        const exportButton = screen.getByRole("button", { name: /export/i });
        expect(exportButton).toBeInTheDocument();
      });
    });
  });

  describe("KPIs Row", () => {
    it("should render Total CVEs KPI", async () => {
      const { VulnerabilityDashboard } = await import(
        "../src/pages/VulnerabilityDashboard"
      );

      renderWithProviders(<VulnerabilityDashboard />);

      await waitFor(() => {
        expect(screen.getByText(/Total CVEs/i)).toBeInTheDocument();
      });
    });

    it("should render Critical count KPI", async () => {
      const { VulnerabilityDashboard } = await import(
        "../src/pages/VulnerabilityDashboard"
      );

      renderWithProviders(<VulnerabilityDashboard />);

      await waitFor(() => {
        // Should have Critical text (multiple instances are OK - KPI and filter)
        const criticalElements = screen.getAllByText(/Critical/i);
        expect(criticalElements.length).toBeGreaterThan(0);
      });
    });

    it("should render KEV count KPI", async () => {
      const { VulnerabilityDashboard } = await import(
        "../src/pages/VulnerabilityDashboard"
      );

      renderWithProviders(<VulnerabilityDashboard />);

      await waitFor(() => {
        // Should have KEV text (KPI label)
        const kevElements = screen.getAllByText(/KEV/i);
        expect(kevElements.length).toBeGreaterThan(0);
      });
    });

    it("should render Exploitable count KPI", async () => {
      const { VulnerabilityDashboard } = await import(
        "../src/pages/VulnerabilityDashboard"
      );

      renderWithProviders(<VulnerabilityDashboard />);

      await waitFor(() => {
        expect(screen.getByText(/Exploitable/i)).toBeInTheDocument();
      });
    });

    it("should render SLA compliance KPI", async () => {
      const { VulnerabilityDashboard } = await import(
        "../src/pages/VulnerabilityDashboard"
      );

      renderWithProviders(<VulnerabilityDashboard />);

      await waitFor(() => {
        expect(screen.getByText(/SLA/i)).toBeInTheDocument();
      });
    });
  });

  describe("Sidebar Filters", () => {
    it("should render severity filter section", async () => {
      const { VulnerabilityDashboard } = await import(
        "../src/pages/VulnerabilityDashboard"
      );

      renderWithProviders(<VulnerabilityDashboard />);

      await waitFor(() => {
        expect(screen.getByText(/Severity/i)).toBeInTheDocument();
      });
    });

    it("should render CVSS range filter", async () => {
      const { VulnerabilityDashboard } = await import(
        "../src/pages/VulnerabilityDashboard"
      );

      renderWithProviders(<VulnerabilityDashboard />);

      await waitFor(() => {
        expect(screen.getByText(/CVSS/i)).toBeInTheDocument();
      });
    });

    it("should render KEV status filter", async () => {
      const { VulnerabilityDashboard } = await import(
        "../src/pages/VulnerabilityDashboard"
      );

      renderWithProviders(<VulnerabilityDashboard />);

      await waitFor(() => {
        expect(screen.getByText(/KEV Only/i)).toBeInTheDocument();
      });
    });

    it("should render SSVC decision filter", async () => {
      const { VulnerabilityDashboard } = await import(
        "../src/pages/VulnerabilityDashboard"
      );

      renderWithProviders(<VulnerabilityDashboard />);

      await waitFor(() => {
        // SSVC Decision section title
        expect(screen.getByText(/SSVC Decision/i)).toBeInTheDocument();
      });
    });

    it("should have checkboxes for severity levels", async () => {
      const { VulnerabilityDashboard } = await import(
        "../src/pages/VulnerabilityDashboard"
      );

      renderWithProviders(<VulnerabilityDashboard />);

      await waitFor(() => {
        const checkboxes = screen.getAllByRole("checkbox");
        expect(checkboxes.length).toBeGreaterThan(0);
      });
    });
  });

  describe("Main Grid Area", () => {
    it("should render placeholder for visual views", async () => {
      const { VulnerabilityDashboard } = await import(
        "../src/pages/VulnerabilityDashboard"
      );

      renderWithProviders(<VulnerabilityDashboard />);

      await waitFor(() => {
        // Should have a main content area for visualizations
        expect(screen.getByTestId("visualization-area")).toBeInTheDocument();
      });
    });

    it("should render view selector with 6 tabs", async () => {
      const { VulnerabilityDashboard } = await import(
        "../src/pages/VulnerabilityDashboard"
      );

      renderWithProviders(<VulnerabilityDashboard />);

      await waitFor(() => {
        const viewSelector = screen.getByTestId("view-selector");
        expect(viewSelector).toBeInTheDocument();
        // Should have 6 view tabs
        const tabs = screen.getAllByRole("tab");
        expect(tabs.length).toBe(6);
      });
    });
  });

  describe("Bottom Action Bar", () => {
    it("should render bottom action bar", async () => {
      const { VulnerabilityDashboard } = await import(
        "../src/pages/VulnerabilityDashboard"
      );

      renderWithProviders(<VulnerabilityDashboard />);

      await waitFor(() => {
        expect(screen.getByTestId("bottom-action-bar")).toBeInTheDocument();
      });
    });

    it("should have enrich vulnerabilities button", async () => {
      const { VulnerabilityDashboard } = await import(
        "../src/pages/VulnerabilityDashboard"
      );

      renderWithProviders(<VulnerabilityDashboard />);

      await waitFor(() => {
        const enrichButton = screen.getByRole("button", {
          name: /enrich vulnerabilities/i,
        });
        expect(enrichButton).toBeInTheDocument();
      });
    });
  });

  describe("Loading State", () => {
    it("should show loading indicator while fetching data", async () => {
      const { VulnerabilityDashboard } = await import(
        "../src/pages/VulnerabilityDashboard"
      );

      renderWithProviders(<VulnerabilityDashboard />);

      // Initially should show loading or quickly transition to content
      // The component should handle loading state gracefully
      await waitFor(
        () => {
          const content = screen.getByText(/Vulnerability Command Center/i);
          expect(content).toBeInTheDocument();
        },
        { timeout: 3000 }
      );
    });
  });
});

// ============================================================================
// useVulnerabilities Hook Tests
// ============================================================================

describe("useVulnerabilities Hook", () => {
  describe("useVulnerabilityOverview", () => {
    it("should be exported from useVulnerabilities module", async () => {
      const hooks = await import("../src/hooks/useVulnerabilities");
      expect(hooks.useVulnerabilityOverview).toBeDefined();
    });

    it("should return summary data structure", async () => {
      const hooks = await import("../src/hooks/useVulnerabilities");

      const TestComponent = () => {
        const { data, isLoading } = hooks.useVulnerabilityOverview();
        if (isLoading) return <div>Loading...</div>;
        return <div data-testid="data">{JSON.stringify(data)}</div>;
      };

      renderWithProviders(<TestComponent />);

      await waitFor(() => {
        const dataElement = screen.getByTestId("data");
        const data = JSON.parse(dataElement.textContent || "{}");
        expect(data).toHaveProperty("total_cves");
      });
    });
  });

  describe("useVulnerabilityList", () => {
    it("should be exported from useVulnerabilities module", async () => {
      const hooks = await import("../src/hooks/useVulnerabilities");
      expect(hooks.useVulnerabilityList).toBeDefined();
    });

    it("should accept filter parameters", async () => {
      const hooks = await import("../src/hooks/useVulnerabilities");

      const TestComponent = () => {
        const { data, isLoading } = hooks.useVulnerabilityList({
          severity: "Critical",
          is_kev: true,
        });
        if (isLoading) return <div>Loading...</div>;
        return <div data-testid="list-data">{JSON.stringify(data)}</div>;
      };

      renderWithProviders(<TestComponent />);

      await waitFor(() => {
        const dataElement = screen.getByTestId("list-data");
        expect(dataElement.textContent).not.toBe("");
      });
    });

    it("should return paginated data with CVEs", async () => {
      const hooks = await import("../src/hooks/useVulnerabilities");

      const TestComponent = () => {
        const { data, isLoading } = hooks.useVulnerabilityList();
        if (isLoading) return <div>Loading...</div>;
        return <div data-testid="list">{data?.data?.length ?? 0} CVEs</div>;
      };

      renderWithProviders(<TestComponent />);

      await waitFor(() => {
        expect(screen.getByTestId("list")).toHaveTextContent(/\d+ CVEs/);
      });
    });
  });

  describe("useVulnerabilitySummary", () => {
    it("should be exported from useVulnerabilities module", async () => {
      const hooks = await import("../src/hooks/useVulnerabilities");
      expect(hooks.useVulnerabilitySummary).toBeDefined();
    });

    it("should return KPI data", async () => {
      const hooks = await import("../src/hooks/useVulnerabilities");

      const TestComponent = () => {
        const { data, isLoading } = hooks.useVulnerabilitySummary();
        if (isLoading) return <div>Loading...</div>;
        return (
          <div data-testid="summary">
            {data?.total_cves !== undefined ? "Has KPIs" : "No KPIs"}
          </div>
        );
      };

      renderWithProviders(<TestComponent />);

      await waitFor(() => {
        expect(screen.getByTestId("summary")).toHaveTextContent("Has KPIs");
      });
    });
  });
});

// ============================================================================
// Sidebar Integration Tests
// ============================================================================

describe("Sidebar Integration", () => {
  it("should have Vulnerabilities menu item in Sidebar", async () => {
    const { Sidebar } = await import("../src/components/Sidebar");

    renderWithProviders(<Sidebar />);

    // Should have a link to vulnerabilities
    const vulnLink = screen.getByRole("link", { name: /vulnerabilities/i });
    expect(vulnLink).toBeInTheDocument();
    expect(vulnLink).toHaveAttribute("href", "/vulnerabilities");
  });

  it("should highlight Vulnerabilities when active", async () => {
    const { Sidebar } = await import("../src/components/Sidebar");

    // Navigate to vulnerabilities route
    window.history.pushState({}, "", "/vulnerabilities");

    renderWithProviders(<Sidebar />);

    const vulnLink = screen.getByRole("link", { name: /vulnerabilities/i });
    // Active link should have different styling (cy cyan-600 class)
    expect(vulnLink.className).toContain("text");
  });
});

// ============================================================================
// Filter Interaction Tests
// ============================================================================

describe("Filter Interactions", () => {
  it("should toggle severity filter when checkbox clicked", async () => {
    const { VulnerabilityDashboard } = await import(
      "../src/pages/VulnerabilityDashboard"
    );

    renderWithProviders(<VulnerabilityDashboard />);

    await waitFor(() => {
      const criticalCheckbox = screen.getByRole("checkbox", { name: /critical/i });
      expect(criticalCheckbox).toBeInTheDocument();
      fireEvent.click(criticalCheckbox);
      expect(criticalCheckbox).toBeChecked();
    });
  });

  it("should toggle KEV filter when clicked", async () => {
    const { VulnerabilityDashboard } = await import(
      "../src/pages/VulnerabilityDashboard"
    );

    renderWithProviders(<VulnerabilityDashboard />);

    await waitFor(() => {
      const kevCheckbox = screen.getByRole("checkbox", { name: /kev only/i });
      fireEvent.click(kevCheckbox);
      expect(kevCheckbox).toBeChecked();
    });
  });

  it("should toggle SSVC decision filter", async () => {
    const { VulnerabilityDashboard } = await import(
      "../src/pages/VulnerabilityDashboard"
    );

    renderWithProviders(<VulnerabilityDashboard />);

    await waitFor(() => {
      const actCheckbox = screen.getByRole("checkbox", { name: /act/i });
      fireEvent.click(actCheckbox);
      expect(actCheckbox).toBeChecked();
    });
  });
});

// ============================================================================
// Action Button Tests
// ============================================================================

describe("Action Buttons", () => {
  it("should call refresh when refresh button clicked", async () => {
    const { VulnerabilityDashboard } = await import(
      "../src/pages/VulnerabilityDashboard"
    );

    renderWithProviders(<VulnerabilityDashboard />);

    await waitFor(() => {
      const refreshButton = screen.getByRole("button", { name: /refresh/i });
      fireEvent.click(refreshButton);
      // Button should be clickable without errors
      expect(refreshButton).toBeEnabled();
    });
  });

  it("should handle export button click", async () => {
    const { VulnerabilityDashboard } = await import(
      "../src/pages/VulnerabilityDashboard"
    );

    renderWithProviders(<VulnerabilityDashboard />);

    await waitFor(() => {
      const exportButton = screen.getByRole("button", { name: /export/i });
      fireEvent.click(exportButton);
      expect(exportButton).toBeEnabled();
    });
  });

  it("should handle enrich vulnerabilities button click", async () => {
    const { VulnerabilityDashboard } = await import(
      "../src/pages/VulnerabilityDashboard"
    );

    renderWithProviders(<VulnerabilityDashboard />);

    await waitFor(() => {
      const enrichButton = screen.getByRole("button", {
        name: /enrich vulnerabilities/i,
      });
      fireEvent.click(enrichButton);
      expect(enrichButton).toBeEnabled();
    });
  });
});

// ============================================================================
// View Selector and Real View Integration Tests
// ============================================================================

describe("View Selector Component", () => {
  it("should render view selector tabs", async () => {
    const { VulnerabilityDashboard } = await import(
      "../src/pages/VulnerabilityDashboard"
    );

    renderWithProviders(<VulnerabilityDashboard />);

    await waitFor(() => {
      // Should have view selector tabs for each view
      expect(screen.getByTestId("view-selector")).toBeInTheDocument();
    });
  });

  it("should have tabs for all 6 views", async () => {
    const { VulnerabilityDashboard } = await import(
      "../src/pages/VulnerabilityDashboard"
    );

    renderWithProviders(<VulnerabilityDashboard />);

    await waitFor(() => {
      expect(screen.getByRole("tab", { name: /risk terrain/i })).toBeInTheDocument();
      expect(screen.getByRole("tab", { name: /vulnerability calendar/i })).toBeInTheDocument();
      expect(screen.getByRole("tab", { name: /cwe sunburst/i })).toBeInTheDocument();
      expect(screen.getByRole("tab", { name: /priority bubbles/i })).toBeInTheDocument();
      expect(screen.getByRole("tab", { name: /exploit dna/i })).toBeInTheDocument();
      expect(screen.getByRole("tab", { name: /remediation flow/i })).toBeInTheDocument();
    });
  });

  it("should switch active view when tab is clicked", async () => {
    const { VulnerabilityDashboard } = await import(
      "../src/pages/VulnerabilityDashboard"
    );

    renderWithProviders(<VulnerabilityDashboard />);

    await waitFor(() => {
      const calendarTab = screen.getByRole("tab", { name: /vulnerability calendar/i });
      fireEvent.click(calendarTab);
      expect(calendarTab).toHaveAttribute("aria-selected", "true");
    });
  });

  it("should display only one view at a time", async () => {
    const { VulnerabilityDashboard } = await import(
      "../src/pages/VulnerabilityDashboard"
    );

    const { container } = renderWithProviders(<VulnerabilityDashboard />);

    await waitFor(() => {
      // When a view is selected, only that view should be visible
      const viewPanel = container.querySelector('[role="tabpanel"]');
      expect(viewPanel).toBeInTheDocument();
    });
  });
});

describe("Real View Components Integration", () => {
  it("should render TerrainView when Risk Terrain tab is active", async () => {
    const { VulnerabilityDashboard } = await import(
      "../src/pages/VulnerabilityDashboard"
    );

    renderWithProviders(<VulnerabilityDashboard />);

    await waitFor(() => {
      const terrainTab = screen.getByRole("tab", { name: /risk terrain/i });
      fireEvent.click(terrainTab);
    });

    await waitFor(() => {
      // TerrainView component should be rendered
      expect(screen.getByTestId("terrain-view") || screen.getByTestId("terrain-loading")).toBeInTheDocument();
    }, { timeout: 5000 });
  });

  it("should render CalendarHeatmap when Calendar tab is active", async () => {
    const { VulnerabilityDashboard } = await import(
      "../src/pages/VulnerabilityDashboard"
    );

    renderWithProviders(<VulnerabilityDashboard />);

    await waitFor(() => {
      const calendarTab = screen.getByRole("tab", { name: /vulnerability calendar/i });
      fireEvent.click(calendarTab);
    });

    await waitFor(() => {
      expect(screen.getByTestId("calendar-heatmap") || screen.getByTestId("calendar-loading")).toBeInTheDocument();
    }, { timeout: 5000 });
  });

  it("should render SunburstChart when CWE Sunburst tab is active", async () => {
    const { VulnerabilityDashboard } = await import(
      "../src/pages/VulnerabilityDashboard"
    );

    renderWithProviders(<VulnerabilityDashboard />);

    await waitFor(() => {
      const sunburstTab = screen.getByRole("tab", { name: /cwe sunburst/i });
      fireEvent.click(sunburstTab);
    });

    await waitFor(() => {
      expect(screen.getByTestId("sunburst-chart") || screen.getByTestId("sunburst-loading")).toBeInTheDocument();
    }, { timeout: 5000 });
  });

  it("should render BubblesView when Priority Bubbles tab is active", async () => {
    const { VulnerabilityDashboard } = await import(
      "../src/pages/VulnerabilityDashboard"
    );

    renderWithProviders(<VulnerabilityDashboard />);

    await waitFor(() => {
      const bubblesTab = screen.getByRole("tab", { name: /priority bubbles/i });
      fireEvent.click(bubblesTab);
    });

    await waitFor(() => {
      expect(screen.getByTestId("bubbles-view") || screen.getByTestId("bubbles-loading")).toBeInTheDocument();
    }, { timeout: 5000 });
  });

  it("should render SankeyFlow when Remediation Flow tab is active", async () => {
    const { VulnerabilityDashboard } = await import(
      "../src/pages/VulnerabilityDashboard"
    );

    renderWithProviders(<VulnerabilityDashboard />);

    await waitFor(() => {
      const sankeyTab = screen.getByRole("tab", { name: /remediation flow/i });
      fireEvent.click(sankeyTab);
    });

    await waitFor(() => {
      expect(screen.getByTestId("sankey-flow") || screen.getByTestId("sankey-loading")).toBeInTheDocument();
    }, { timeout: 5000 });
  });
});
