/**
 * VulnerabilityDashboard - Vulnerability Intelligence Command Center
 *
 * Features:
 * - Header with title and KPIs row
 * - Sidebar for filters (severity, CVSS range, KEV status, SSVC decision)
 * - Main grid area for 6 visual views (placeholders)
 * - Bottom action bar with refresh and export buttons
 */

import { useState, useCallback } from "react";
import clsx from "clsx";
import {
  useVulnerabilityOverview,
  useVulnerabilityList,
  useTerrainData,
  useCalendarHeatmapData,
  useSunburstData,
  useBubblesData,
  useDNAData,
  useSankeyFlowData,
} from "../hooks/useVulnerabilities";
import { useToast } from "../utils/toast";
import {
  TerrainView,
  CalendarHeatmap,
  SunburstChart,
  BubblesView,
  DNAView,
  SankeyFlow,
} from "../components/vuln-views";

// ============================================================================
// Types
// ============================================================================

interface FilterState {
  severity: string[];
  cvssMin: number;
  cvssMax: number;
  isKev: boolean;
  ssvcDecision: string[];
  search: string;
}

type ViewType = "terrain" | "calendar" | "sunburst" | "bubbles" | "dna" | "sankey";

const VIEW_TABS: { id: ViewType; label: string; icon: string }[] = [
  { id: "terrain", label: "Risk Terrain", icon: "mountain" },
  { id: "calendar", label: "Vulnerability Calendar", icon: "calendar" },
  { id: "sunburst", label: "CWE Sunburst", icon: "chart-pie" },
  { id: "bubbles", label: "Priority Bubbles", icon: "bubbles" },
  { id: "dna", label: "Exploit DNA", icon: "dna" },
  { id: "sankey", label: "Remediation Flow", icon: "flow" },
];

// ============================================================================
// Component
// ============================================================================

export function VulnerabilityDashboard() {
  const { showToast } = useToast();

  // Filter state
  const [filters, setFilters] = useState<FilterState>({
    severity: [],
    cvssMin: 0,
    cvssMax: 10,
    isKev: false,
    ssvcDecision: [],
    search: "",
  });

  // Active view state
  const [activeView, setActiveView] = useState<ViewType>("terrain");

  // Data hooks
  const { data: overview, isLoading: overviewLoading, refetch: refetchOverview } = useVulnerabilityOverview();
  const { data: _vulnList, isLoading: listLoading, refetch: refetchList } = useVulnerabilityList({
    severity: filters.severity.length === 1 ? filters.severity[0] : undefined,
    cvss_min: filters.cvssMin > 0 ? filters.cvssMin : undefined,
    cvss_max: filters.cvssMax < 10 ? filters.cvssMax : undefined,
    is_kev: filters.isKev || undefined,
    ssvc_decision: filters.ssvcDecision.length === 1 ? filters.ssvcDecision[0] : undefined,
    search: filters.search || undefined,
  });

  // Visualization data hooks
  const { data: terrainData, isLoading: terrainLoading, error: terrainError } = useTerrainData();
  const { data: calendarData, isLoading: calendarLoading, error: calendarError } = useCalendarHeatmapData();
  const { data: sunburstData, isLoading: sunburstLoading, error: sunburstError } = useSunburstData();
  const { data: bubblesData, isLoading: bubblesLoading, error: bubblesError } = useBubblesData();
  const { data: dnaData, isLoading: dnaLoading, error: dnaError } = useDNAData();
  const { data: sankeyData, isLoading: sankeyLoading, error: sankeyError } = useSankeyFlowData();

  // Handlers
  const handleRefresh = useCallback(() => {
    refetchOverview();
    refetchList();
    showToast("info", "Refreshing vulnerability data...", 2000);
  }, [refetchOverview, refetchList, showToast]);

  const handleExport = useCallback(() => {
    showToast("info", "Export functionality coming soon", 2000);
  }, [showToast]);

  const handleEnrichVulnerabilities = useCallback(async () => {
    showToast("info", "Starting vulnerability enrichment...", 3000);
    // TODO: Implement enrichment API call
  }, [showToast]);

  const handleCVEClick = useCallback((cveId: string) => {
    showToast("info", `Selected CVE: ${cveId}`, 2000);
    // TODO: Open CVE detail modal or navigate
  }, [showToast]);

  const toggleSeverity = useCallback((severity: string) => {
    setFilters((prev) => ({
      ...prev,
      severity: prev.severity.includes(severity)
        ? prev.severity.filter((s) => s !== severity)
        : [...prev.severity, severity],
    }));
  }, []);

  const toggleSsvc = useCallback((decision: string) => {
    setFilters((prev) => ({
      ...prev,
      ssvcDecision: prev.ssvcDecision.includes(decision)
        ? prev.ssvcDecision.filter((d) => d !== decision)
        : [...prev.ssvcDecision, decision],
    }));
  }, []);

  const toggleKev = useCallback(() => {
    setFilters((prev) => ({ ...prev, isKev: !prev.isKev }));
  }, []);

  // Loading state
  const isLoading = overviewLoading || listLoading;

  return (
    <div className="h-full flex flex-col space-y-4">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gradient-to-br from-[var(--gradient-danger-from)] to-[var(--gradient-danger-to)] rounded-lg flex items-center justify-center">
            <svg
              className="w-6 h-6 text-primary"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              />
            </svg>
          </div>
          <div>
            <h1 className="text-2xl font-bold text-primary">
              Vulnerability Command Center
            </h1>
            <p className="text-secondary text-sm">
              Real-time CVE intelligence with SSVC prioritization
            </p>
          </div>
        </div>

        <div className="flex items-center gap-3">
          <button
            onClick={handleRefresh}
            aria-label="Refresh"
            className="px-4 py-2 bg-tertiary hover:bg-tertiary text-primary rounded-lg transition-colors flex items-center gap-2"
          >
            <svg
              className={clsx("w-5 h-5", isLoading && "animate-spin")}
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              />
            </svg>
            Refresh
          </button>
          <button
            onClick={handleExport}
            aria-label="Export"
            className="px-4 py-2 bg-[var(--accent-button-bg)] hover:bg-[var(--accent-button-hover)] text-primary rounded-lg transition-colors flex items-center gap-2"
          >
            <svg
              className="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              />
            </svg>
            Export
          </button>
        </div>
      </div>

      {/* KPIs Row */}
      <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
        <KPICard
          label="Total CVEs"
          value={overview?.total_cves ?? 0}
          color="cyan"
        />
        <KPICard
          label="Critical"
          value={overview?.critical_count ?? 0}
          color="red"
          flash={!!overview?.critical_count}
        />
        <KPICard
          label="KEV"
          value={overview?.kev_count ?? 0}
          color="orange"
          glow
        />
        <KPICard
          label="Exploitable"
          value={overview?.exploitable_count ?? 0}
          color="purple"
        />
        <KPICard
          label="Overdue"
          value={overview?.overdue_count ?? 0}
          color="red"
          flash={!!overview?.overdue_count}
        />
        <KPICard
          label="SLA %"
          value={`${overview?.sla_compliance_percent?.toFixed(1) ?? 0}%`}
          color={
            (overview?.sla_compliance_percent ?? 0) >= 85 ? "green" : "red"
          }
        />
        <KPICard
          label="MTTR"
          value={`${overview?.mttr_days?.toFixed(1) ?? 0}d`}
          color="blue"
        />
      </div>

      {/* Main Content Area */}
      <div className="flex-1 flex gap-4 min-h-0">
        {/* Sidebar Filters */}
        <aside className="w-64 bg-secondary rounded-lg p-4 space-y-6 overflow-y-auto">
          {/* Severity Filter */}
          <div>
            <h3 className="text-sm font-semibold text-secondary uppercase mb-3">
              Severity
            </h3>
            <div className="space-y-2">
              {["Critical", "High", "Medium", "Low"].map((severity) => (
                <label
                  key={severity}
                  className="flex items-center gap-2 cursor-pointer"
                >
                  <input
                    type="checkbox"
                    checked={filters.severity.includes(severity)}
                    onChange={() => toggleSeverity(severity)}
                    aria-label={severity}
                    className="w-4 h-4 rounded border-primary bg-tertiary text-[var(--accent-link)] focus:ring-[var(--border-focus)]"
                  />
                  <span
                    className={clsx(
                      "text-sm",
                      severity === "Critical" && "text-[var(--score-critical)]",
                      severity === "High" && "text-[var(--score-high)]",
                      severity === "Medium" && "text-[var(--score-medium)]",
                      severity === "Low" && "text-[var(--score-low)]"
                    )}
                  >
                    {severity}
                  </span>
                  <span className="text-xs text-tertiary ml-auto">
                    {severity === "Critical" && (overview?.critical_count ?? 0)}
                    {severity === "High" && (overview?.high_count ?? 0)}
                    {severity === "Medium" && (overview?.medium_count ?? 0)}
                    {severity === "Low" && (overview?.low_count ?? 0)}
                  </span>
                </label>
              ))}
            </div>
          </div>

          {/* CVSS Range */}
          <div>
            <h3 className="text-sm font-semibold text-secondary uppercase mb-3">
              CVSS Range
            </h3>
            <div className="flex items-center gap-2">
              <input
                type="number"
                min="0"
                max="10"
                step="0.1"
                value={filters.cvssMin}
                onChange={(e) =>
                  setFilters((prev) => ({
                    ...prev,
                    cvssMin: parseFloat(e.target.value) || 0,
                  }))
                }
                className="w-16 px-2 py-1 bg-tertiary border border-primary rounded text-primary text-sm"
              />
              <span className="text-secondary">-</span>
              <input
                type="number"
                min="0"
                max="10"
                step="0.1"
                value={filters.cvssMax}
                onChange={(e) =>
                  setFilters((prev) => ({
                    ...prev,
                    cvssMax: parseFloat(e.target.value) || 10,
                  }))
                }
                className="w-16 px-2 py-1 bg-tertiary border border-primary rounded text-primary text-sm"
              />
            </div>
          </div>

          {/* KEV Status */}
          <div>
            <h3 className="text-sm font-semibold text-secondary uppercase mb-3">
              Quick Filters
            </h3>
            <label className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={filters.isKev}
                onChange={toggleKev}
                aria-label="KEV Only"
                className="w-4 h-4 rounded border-primary bg-tertiary text-[var(--score-critical)] focus:ring-[var(--border-focus)]"
              />
              <span className="text-sm text-[var(--score-high)]">KEV Only</span>
              <span className="text-xs text-tertiary ml-auto">
                {overview?.kev_count ?? 0}
              </span>
            </label>
          </div>

          {/* SSVC Decision */}
          <div>
            <h3 className="text-sm font-semibold text-secondary uppercase mb-3">
              SSVC Decision
            </h3>
            <div className="space-y-2">
              {[
                { value: "Act", color: "text-[var(--score-critical)]" },
                { value: "Attend", color: "text-[var(--score-high)]" },
                { value: "Track*", color: "text-[var(--score-medium)]" },
                { value: "Track", color: "text-[var(--score-low)]" },
              ].map(({ value, color }) => (
                <label
                  key={value}
                  className="flex items-center gap-2 cursor-pointer"
                >
                  <input
                    type="checkbox"
                    checked={filters.ssvcDecision.includes(value)}
                    onChange={() => toggleSsvc(value)}
                    aria-label={value}
                    className="w-4 h-4 rounded border-primary bg-tertiary text-[var(--accent-link)] focus:ring-[var(--border-focus)]"
                  />
                  <span className={clsx("text-sm", color)}>{value}</span>
                  <span className="text-xs text-tertiary ml-auto">
                    {value === "Act" && (overview?.ssvc_act ?? 0)}
                    {value === "Attend" && (overview?.ssvc_attend ?? 0)}
                    {value === "Track*" && (overview?.ssvc_track_star ?? 0)}
                    {value === "Track" && (overview?.ssvc_track ?? 0)}
                  </span>
                </label>
              ))}
            </div>
          </div>

          {/* Search */}
          <div>
            <h3 className="text-sm font-semibold text-secondary uppercase mb-3">
              Search
            </h3>
            <input
              type="text"
              placeholder="CVE-2024-..."
              value={filters.search}
              onChange={(e) =>
                setFilters((prev) => ({ ...prev, search: e.target.value }))
              }
              className="w-full px-3 py-2 bg-tertiary border border-primary rounded-lg text-primary text-sm placeholder-[var(--text-tertiary)] focus:outline-none focus:border-[var(--border-focus)]"
            />
          </div>
        </aside>

        {/* Main Grid / Visualization Area */}
        <main
          className="flex-1 bg-secondary rounded-lg p-4 overflow-auto flex flex-col"
          data-testid="visualization-area"
        >
          {/* View Selector Tabs */}
          <ViewSelector
            activeView={activeView}
            onViewChange={setActiveView}
          />

          {/* Active View Panel */}
          <div
            role="tabpanel"
            className="flex-1 mt-4 min-h-0"
            aria-labelledby={`tab-${activeView}`}
          >
            {activeView === "terrain" && (
              <TerrainView
                data={terrainData ?? { points: [], grid_size: 10, max_cvss: 10, total_cves: 0 }}
                isLoading={terrainLoading}
                error={terrainError?.message ?? null}
                onCVEClick={handleCVEClick}
                className="h-full"
              />
            )}
            {activeView === "calendar" && (
              <CalendarHeatmap
                data={calendarData ?? { days: [], start_date: "", end_date: "", max_count: 0, total_cves: 0 }}
                isLoading={calendarLoading}
                error={calendarError?.message ?? null}
                className="h-full"
              />
            )}
            {activeView === "sunburst" && (
              <SunburstChart
                data={sunburstData ?? { root: { name: "CWE", value: 0 }, total_cves: 0, total_cwes: 0 }}
                isLoading={sunburstLoading}
                error={sunburstError?.message ?? null}
                onCVEClick={handleCVEClick}
                className="h-full"
              />
            )}
            {activeView === "bubbles" && (
              <BubblesView
                data={bubblesData ?? { bubbles: [], total_cves: 0, severity_distribution: { critical: 0, high: 0, medium: 0, low: 0 } }}
                isLoading={bubblesLoading}
                error={bubblesError?.message ?? null}
                onCVEClick={handleCVEClick}
                filterSeverity={filters.severity.length > 0 ? filters.severity : undefined}
                filterSSVC={filters.ssvcDecision.length > 0 ? filters.ssvcDecision : undefined}
                className="h-full"
              />
            )}
            {activeView === "dna" && (
              <DNAView
                data={dnaData ?? { strands: [], total_pairs: 0, kev_pairs: 0, exploitable_pairs: 0 }}
                isLoading={dnaLoading}
                error={dnaError?.message ?? null}
                onCVEClick={handleCVEClick}
                className="h-full"
              />
            )}
            {activeView === "sankey" && (
              <SankeyFlow
                data={sankeyData ?? { nodes: [], links: [], total_cves: 0, remediated_count: 0, in_progress_count: 0, open_count: 0 }}
                isLoading={sankeyLoading}
                error={sankeyError?.message ?? null}
                className="h-full"
              />
            )}
          </div>
        </main>
      </div>

      {/* Bottom Action Bar */}
      <div
        className="bg-secondary rounded-lg px-4 py-3 flex items-center justify-between"
        data-testid="bottom-action-bar"
      >
        <div className="flex items-center gap-4">
          {/* Remediation Progress */}
          <div className="flex items-center gap-3">
            <span className="text-sm text-secondary">Remediation:</span>
            <div className="w-48 h-3 bg-tertiary rounded-full overflow-hidden flex">
              <div
                className="h-full bg-[var(--progress-success)]"
                style={{
                  width: `${
                    ((overview?.remediated_count ?? 0) /
                      Math.max(overview?.total_cves ?? 1, 1)) *
                    100
                  }%`,
                }}
              />
              <div
                className="h-full bg-[var(--progress-info)]"
                style={{
                  width: `${
                    ((overview?.in_progress_count ?? 0) /
                      Math.max(overview?.total_cves ?? 1, 1)) *
                    100
                  }%`,
                }}
              />
              <div
                className="h-full bg-tertiary"
                style={{
                  width: `${
                    ((overview?.open_count ?? 0) /
                      Math.max(overview?.total_cves ?? 1, 1)) *
                    100
                  }%`,
                }}
              />
            </div>
            <div className="flex items-center gap-2 text-xs">
              <span className="flex items-center gap-1">
                <span className="w-2 h-2 rounded-full bg-[var(--progress-success)]" />
                <span className="text-secondary">
                  {overview?.remediated_count ?? 0}
                </span>
              </span>
              <span className="flex items-center gap-1">
                <span className="w-2 h-2 rounded-full bg-[var(--progress-info)]" />
                <span className="text-secondary">
                  {overview?.in_progress_count ?? 0}
                </span>
              </span>
              <span className="flex items-center gap-1">
                <span className="w-2 h-2 rounded-full bg-tertiary" />
                <span className="text-secondary">{overview?.open_count ?? 0}</span>
              </span>
            </div>
          </div>
        </div>

        <div className="flex items-center gap-3">
          <button
            onClick={handleEnrichVulnerabilities}
            aria-label="Enrich Vulnerabilities"
            className="px-4 py-2 bg-[var(--color-error)] hover:opacity-90 text-primary rounded-lg transition-colors flex items-center gap-2 font-medium"
          >
            <svg
              className="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M13 10V3L4 14h7v7l9-11h-7z"
              />
            </svg>
            Enrich Vulnerabilities
          </button>
        </div>
      </div>
    </div>
  );
}

// ============================================================================
// Sub-components
// ============================================================================

interface KPICardProps {
  label: string;
  value: number | string;
  color: "cyan" | "red" | "orange" | "purple" | "green" | "blue";
  flash?: boolean;
  glow?: boolean;
}

function KPICard({ label, value, color, flash, glow }: KPICardProps) {
  const colorClasses: Record<string, string> = {
    cyan: "text-[var(--kpi-cyan)] border-[var(--kpi-cyan-border)]",
    red: "text-[var(--kpi-red)] border-[var(--kpi-red-border)]",
    orange: "text-[var(--kpi-orange)] border-[var(--kpi-orange-border)]",
    purple: "text-[var(--kpi-purple)] border-[var(--kpi-purple-border)]",
    green: "text-[var(--kpi-green)] border-[var(--kpi-green-border)]",
    blue: "text-[var(--kpi-blue)] border-[var(--kpi-blue-border)]",
  };

  return (
    <div
      className={clsx(
        "bg-secondary rounded-lg p-3 border",
        colorClasses[color],
        flash && "animate-pulse",
        glow && "shadow-lg"
      )}
    >
      <div className={clsx("text-2xl font-bold", colorClasses[color].split(" ")[0])}>
        {value}
      </div>
      <div className="text-xs text-secondary">{label}</div>
    </div>
  );
}

interface ViewSelectorProps {
  activeView: ViewType;
  onViewChange: (view: ViewType) => void;
}

function ViewSelector({ activeView, onViewChange }: ViewSelectorProps) {
  const iconPaths: Record<string, string> = {
    mountain:
      "M5 19l7-12 7 12H5zm7-12l3 6H9l3-6zm0-5c-.6 0-1 .4-1 1v2c0 .6.4 1 1 1s1-.4 1-1V3c0-.6-.4-1-1-1z",
    calendar:
      "M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z",
    "chart-pie":
      "M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z",
    bubbles:
      "M12 8c-2.2 0-4 1.8-4 4s1.8 4 4 4 4-1.8 4-4-1.8-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-3c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM6 13c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z",
    dna: "M12 2v20M9 4h6M6 8h12M6 12h12M6 16h12M9 20h6",
    flow: "M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z",
  };

  return (
    <div
      data-testid="view-selector"
      role="tablist"
      aria-label="Visualization views"
      className="flex flex-wrap gap-1 bg-primary/50 rounded-lg p-1"
    >
      {VIEW_TABS.map((tab) => (
        <button
          key={tab.id}
          id={`tab-${tab.id}`}
          role="tab"
          aria-selected={activeView === tab.id}
          aria-controls={`panel-${tab.id}`}
          onClick={() => onViewChange(tab.id)}
          className={clsx(
            "flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium transition-colors",
            activeView === tab.id
              ? "bg-[var(--accent-button-bg)] text-primary"
              : "text-secondary hover:text-primary hover:bg-tertiary"
          )}
        >
          <svg
            className="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d={iconPaths[tab.icon] || iconPaths.flow}
            />
          </svg>
          <span className="hidden sm:inline">{tab.label}</span>
        </button>
      ))}
    </div>
  );
}
