# MCP Vulnerability Enrichment Tools

This document describes the MCP (Model Context Protocol) tools available for vulnerability enrichment in the CyberDemo SOC platform.

## Overview

The vulnerability MCP tools enable AI agents to:
- Enrich CVEs with multi-source vulnerability data (NVD, EPSS, KEV, OSV)
- Get SSVC (Stakeholder-Specific Vulnerability Categorization) decisions
- Search enriched vulnerabilities with filters
- Calculate composite risk scores

## Available Tools

### 1. vuln_enrich_cve

Enrich one or more CVEs with vulnerability intelligence from multiple sources.

**Input Schema:**
```json
{
  "type": "object",
  "properties": {
    "cve_ids": {
      "type": "array",
      "items": {"type": "string"},
      "description": "List of CVE IDs to enrich (max 100)"
    },
    "sources": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": ["nvd", "epss", "kev", "osv", "ghsa", "exploitdb"]
      },
      "description": "Sources to use. Default: ['nvd', 'epss', 'kev']"
    },
    "force_refresh": {
      "type": "boolean",
      "description": "Bypass cache and fetch fresh data",
      "default": false
    }
  },
  "required": ["cve_ids"]
}
```

**Example Request:**
```json
{
  "method": "tools/call",
  "params": {
    "name": "vuln_enrich_cve",
    "arguments": {
      "cve_ids": ["CVE-2024-1234", "CVE-2024-5678"],
      "sources": ["nvd", "epss", "kev"]
    }
  }
}
```

**Example Response:**
```json
{
  "job_id": "abc123-def456",
  "total_items": 2,
  "enriched_cves": [
    {
      "cve_id": "CVE-2024-1234",
      "cvss_v3_score": 9.8,
      "epss_score": 0.95,
      "is_kev": true,
      "ssvc_decision": "Act",
      "risk_score": 92
    }
  ],
  "sources": {
    "nvd": {"status": "success", "enriched_count": 2},
    "epss": {"status": "success", "enriched_count": 2},
    "kev": {"status": "success", "enriched_count": 2}
  },
  "successful_sources": 3,
  "failed_sources": 0
}
```

---

### 2. vuln_get_ssvc_decision

Get SSVC (Stakeholder-Specific Vulnerability Categorization) decision for a CVE.

SSVC Decisions:
- **Act**: Immediate action required (active exploitation, automatable)
- **Attend**: Prioritized remediation (active exploitation, not automatable)
- **Track***: Watch closely (POC exists, high impact)
- **Track**: Monitor normally (low risk)

**Input Schema:**
```json
{
  "type": "object",
  "properties": {
    "cve_id": {
      "type": "string",
      "description": "CVE ID to classify"
    },
    "is_kev": {
      "type": "boolean",
      "description": "Override KEV status (optional)"
    },
    "epss_score": {
      "type": "number",
      "description": "Override EPSS score (0.0-1.0, optional)"
    },
    "exploit_count": {
      "type": "integer",
      "description": "Number of known exploits (default: 0)"
    },
    "cvss_v3_score": {
      "type": "number",
      "description": "Override CVSS v3 score (0.0-10.0, optional)"
    },
    "cvss_v3_vector": {
      "type": "string",
      "description": "CVSS v3 vector string (optional)"
    }
  },
  "required": ["cve_id"]
}
```

**Example Request:**
```json
{
  "method": "tools/call",
  "params": {
    "name": "vuln_get_ssvc_decision",
    "arguments": {
      "cve_id": "CVE-2024-1234",
      "is_kev": true,
      "cvss_v3_score": 9.8
    }
  }
}
```

**Example Response:**
```json
{
  "cve_id": "CVE-2024-1234",
  "ssvc_decision": "Act",
  "exploitation_status": "active",
  "automatable": true,
  "technical_impact": "total",
  "mission_prevalence": "essential",
  "input_data": {
    "is_kev": true,
    "epss_score": 0.95,
    "cvss_v3_score": 9.8,
    "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
    "exploit_count": 0
  }
}
```

---

### 3. vuln_search

Search enriched vulnerabilities with filters.

**Input Schema:**
```json
{
  "type": "object",
  "properties": {
    "ssvc_decision": {
      "type": "string",
      "enum": ["Act", "Attend", "Track*", "Track"],
      "description": "Filter by SSVC decision"
    },
    "risk_level": {
      "type": "string",
      "enum": ["Critical", "High", "Medium", "Low"],
      "description": "Filter by risk level"
    },
    "min_cvss_score": {
      "type": "number",
      "description": "Minimum CVSS v3 score (0.0-10.0)"
    },
    "min_epss_score": {
      "type": "number",
      "description": "Minimum EPSS score (0.0-1.0)"
    },
    "is_kev": {
      "type": "boolean",
      "description": "Filter by KEV status"
    },
    "cwe_id": {
      "type": "string",
      "description": "Filter by CWE ID (e.g., 'CWE-79')"
    },
    "affected_product": {
      "type": "string",
      "description": "Filter by affected product name"
    },
    "limit": {
      "type": "integer",
      "default": 50,
      "maximum": 100
    },
    "offset": {
      "type": "integer",
      "default": 0
    }
  }
}
```

**Example Request:**
```json
{
  "method": "tools/call",
  "params": {
    "name": "vuln_search",
    "arguments": {
      "ssvc_decision": "Act",
      "is_kev": true,
      "limit": 10
    }
  }
}
```

**Example Response:**
```json
{
  "vulnerabilities": [
    {
      "cve_id": "CVE-2024-1234",
      "cvss_v3_score": 9.8,
      "epss_score": 0.95,
      "is_kev": true,
      "ssvc_decision": "Act",
      "risk_level": "Critical",
      "risk_score": 92,
      "cwe_ids": ["CWE-94"],
      "affected_products": ["Apache Log4j"]
    }
  ],
  "total_count": 25,
  "limit": 10,
  "offset": 0,
  "filters_applied": {
    "ssvc_decision": "Act",
    "is_kev": true
  }
}
```

---

### 4. vuln_get_risk_assessment

Get composite risk score for a CVE combining multiple intelligence factors.

**Risk Score Components (0-100):**
| Component | Weight | Description |
|-----------|--------|-------------|
| CVSS Score | 25% | Base severity from NVD |
| EPSS Score | 25% | Exploit prediction probability |
| KEV Status | 15% | In CISA Known Exploited Vulnerabilities |
| Exploit Maturity | 15% | Availability and sophistication of exploits |
| Asset Impact | 10% | Impact on critical assets |
| Exposure | 10% | Internet exposure via Shodan |

**Risk Levels:**
- **Critical** (>= 85): Immediate action required
- **High** (>= 70): Prioritized remediation
- **Medium** (>= 40): Scheduled remediation
- **Low** (< 40): Monitor and review

**Input Schema:**
```json
{
  "type": "object",
  "properties": {
    "cve_id": {
      "type": "string",
      "description": "CVE ID to assess"
    },
    "cvss_v3_score": {
      "type": "number",
      "description": "CVSS v3 score (0.0-10.0, optional)"
    },
    "epss_score": {
      "type": "number",
      "description": "EPSS score (0.0-1.0, optional)"
    },
    "is_kev": {
      "type": "boolean",
      "description": "KEV status (optional)"
    },
    "exploit_maturity": {
      "type": "string",
      "enum": ["weaponized", "poc", "unproven", "none"],
      "default": "none"
    },
    "affected_critical_assets": {
      "type": "integer",
      "default": 0
    },
    "total_critical_assets": {
      "type": "integer",
      "default": 1
    },
    "shodan_exposed_count": {
      "type": "integer",
      "default": 0
    }
  },
  "required": ["cve_id"]
}
```

**Example Request:**
```json
{
  "method": "tools/call",
  "params": {
    "name": "vuln_get_risk_assessment",
    "arguments": {
      "cve_id": "CVE-2024-1234",
      "cvss_v3_score": 9.8,
      "epss_score": 0.95,
      "is_kev": true,
      "exploit_maturity": "weaponized"
    }
  }
}
```

**Example Response:**
```json
{
  "cve_id": "CVE-2024-1234",
  "risk_score": 92.4,
  "risk_level": "Critical",
  "components": {
    "cvss": 24.5,
    "epss": 23.75,
    "kev": 15.0,
    "exploit": 15.0,
    "asset": 5.0,
    "exposure": 10.0
  },
  "input_data": {
    "cvss_v3_score": 9.8,
    "epss_score": 0.95,
    "is_kev": true,
    "exploit_maturity": "weaponized",
    "affected_critical_assets": 10,
    "total_critical_assets": 20,
    "shodan_exposed_count": 500
  }
}
```

---

## Integration with MCP Server

These tools are registered in the MCP server and can be called via the JSON-RPC 2.0 interface.

### Endpoint
```
POST /mcp/messages
```

### List Available Tools
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/list"
}
```

### Call a Tool
```json
{
  "jsonrpc": "2.0",
  "id": 2,
  "method": "tools/call",
  "params": {
    "name": "vuln_enrich_cve",
    "arguments": {
      "cve_ids": ["CVE-2024-1234"]
    }
  }
}
```

---

## Data Sources

| Source | Description | Data Provided |
|--------|-------------|---------------|
| NVD | NIST Vulnerability Database | CVSS scores, CWE, CPE |
| EPSS | Exploit Prediction Scoring System | Exploit probability (0-1) |
| KEV | CISA Known Exploited Vulnerabilities | Active exploitation status |
| OSV | Open Source Vulnerabilities | Affected packages |
| GHSA | GitHub Security Advisories | GitHub-specific advisories |
| ExploitDB | Exploit Database | Available exploits |

---

## Error Handling

Tools return structured error responses:

```json
{
  "error": {
    "code": -32602,
    "message": "Invalid CVE ID format: INVALID-ID"
  }
}
```

Common error codes:
- `-32600`: Invalid request
- `-32601`: Method not found
- `-32602`: Invalid params
- `-32603`: Internal error

---

## Best Practices

1. **Batch Requests**: Use `vuln_enrich_cve` with multiple CVE IDs (up to 100) for efficiency
2. **Caching**: Enrichment data is cached for 1 hour; use `force_refresh: true` for fresh data
3. **Prioritization**: Use SSVC decisions for vulnerability prioritization workflows
4. **Risk Assessment**: Combine risk scores with organizational context for remediation planning
