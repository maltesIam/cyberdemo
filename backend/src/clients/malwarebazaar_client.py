"""
MalwareBazaar API Client.

MalwareBazaar (abuse.ch) provides malware sample intelligence including
file hashes, signatures, and tags.

API Documentation: https://bazaar.abuse.ch/api/
Free, unlimited API.
"""

import logging
from typing import Optional, Dict

import httpx


logger = logging.getLogger(__name__)

# Constants
MALWAREBAZAAR_API_BASE_URL = "https://mb-api.abuse.ch/api/v1/"
DEFAULT_TIMEOUT = 30  # seconds


class MalwareBazaarClient:
    """
    Client for MalwareBazaar API.

    Provides malware sample intelligence including file hashes,
    signatures, and tags.
    """

    def __init__(self, timeout: int = DEFAULT_TIMEOUT):
        """
        Initialize MalwareBazaar client.

        Args:
            timeout: Request timeout in seconds.
        """
        self.timeout = timeout
        self.client = httpx.AsyncClient(timeout=timeout)

    async def close(self):
        """Close the HTTP client."""
        await self.client.aclose()

    async def query_hash(self, file_hash: str) -> Optional[Dict]:
        """
        Query MalwareBazaar by file hash (SHA256, MD5, or SHA1).

        Args:
            file_hash: The file hash to query.

        Returns:
            Dict with query results on success, None on API error.
            Dict structure:
            {
                "query_status": "ok" | "hash_not_found" | "illegal_hash",
                "data": [{
                    "sha256_hash": str,
                    "md5_hash": str,
                    "sha1_hash": str,
                    "file_type": str,
                    "file_size": int,
                    "signature": str,
                    "first_seen": str,
                    "last_seen": str,
                    "tags": list[str],
                    "intelligence": dict
                }]
            }
        """
        data = {
            "query": "get_info",
            "hash": file_hash
        }

        return await self._make_request(data)

    async def query_tag(self, tag: str) -> Optional[Dict]:
        """
        Query MalwareBazaar by tag.

        Args:
            tag: The tag to query (e.g., "Emotet", "Cobalt Strike").

        Returns:
            Dict with query results on success, None on API error.
        """
        data = {
            "query": "get_taginfo",
            "tag": tag
        }

        return await self._make_request(data)

    async def query_signature(self, signature: str) -> Optional[Dict]:
        """
        Query MalwareBazaar by malware signature/family name.

        Args:
            signature: The signature name to query (e.g., "CobaltStrike").

        Returns:
            Dict with query results on success, None on API error.
        """
        data = {
            "query": "get_siginfo",
            "signature": signature
        }

        return await self._make_request(data)

    async def _make_request(self, data: Dict) -> Optional[Dict]:
        """
        Make a POST request to MalwareBazaar API.

        Args:
            data: Form-encoded data to send.

        Returns:
            Dict with API response on success, None on error.
        """
        try:
            response = await self.client.post(
                MALWAREBAZAAR_API_BASE_URL,
                data=data
            )

            # Handle server errors
            if response.status_code >= 500:
                logger.error(
                    f"MalwareBazaar API server error: {response.status_code}"
                )
                return None

            if response.status_code != 200:
                logger.error(
                    f"MalwareBazaar API error: {response.status_code}"
                )
                return None

            return response.json()

        except httpx.TimeoutException:
            logger.error("MalwareBazaar API timeout")
            return None

        except httpx.RequestError as e:
            logger.error(f"MalwareBazaar API request error: {e}")
            return None

        except Exception as e:
            logger.error(f"Unexpected error querying MalwareBazaar: {e}")
            return None
