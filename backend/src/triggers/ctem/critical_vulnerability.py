"""Trigger handler for critical vulnerability detection."""

from typing import Optional
from ..base import BaseTriggerHandler, TriggerEvent
from ..gateway_client import GatewayClient


class CriticalVulnerabilityTrigger(BaseTriggerHandler):
    """Trigger that fires when a critical vulnerability is discovered.

    This trigger monitors for new vulnerabilities with critical CVSS scores
    (>= 9.0) and triggers vulnerability assessment.
    """

    # Minimum CVSS score to trigger
    CRITICAL_CVSS_THRESHOLD = 9.0

    def __init__(self, gateway_client: Optional[GatewayClient] = None):
        super().__init__(gateway_client)

    @property
    def trigger_name(self) -> str:
        return "critical_vulnerability"

    @property
    def description(self) -> str:
        return "Triggers when a critical CVE (CVSS >= 9.0) is discovered"

    @property
    def event_types(self) -> list[str]:
        return ["ctem.vulnerability.new"]

    def should_trigger(self, event: TriggerEvent) -> bool:
        """Check if the vulnerability is critical."""
        data = event.data

        cvss_score = data.get("cvss_score", 0)
        if cvss_score < self.CRITICAL_CVSS_THRESHOLD:
            return False

        return True

    def get_command(self, event: TriggerEvent) -> str:
        """Generate the /assess-vuln command."""
        cve_id = event.data.get("cve_id", "unknown")
        cvss_score = event.data.get("cvss_score", 0)
        affected_assets = event.data.get("affected_assets", [])
        asset_count = len(affected_assets)

        return f"/assess-vuln {cve_id} --cvss {cvss_score} --affected-count {asset_count}"
