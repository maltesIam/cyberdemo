"""Trigger handler for VIP asset vulnerabilities."""

from typing import Optional
from ..base import BaseTriggerHandler, TriggerEvent
from ..gateway_client import GatewayClient


class VIPAssetVulnerabilityTrigger(BaseTriggerHandler):
    """Trigger that fires when any vulnerability affects a VIP asset.

    This trigger monitors for vulnerabilities affecting high-value assets
    like executive devices or critical infrastructure, regardless of CVSS score.
    """

    # Asset classifications that trigger regardless of severity
    VIP_CLASSIFICATIONS = {"vip", "critical_infrastructure", "executive", "crown_jewel"}

    def __init__(self, gateway_client: Optional[GatewayClient] = None):
        super().__init__(gateway_client)

    @property
    def trigger_name(self) -> str:
        return "vip_asset_vulnerability"

    @property
    def description(self) -> str:
        return "Triggers when any vulnerability affects a VIP or critical infrastructure asset"

    @property
    def event_types(self) -> list[str]:
        return ["ctem.vulnerability.new"]

    def should_trigger(self, event: TriggerEvent) -> bool:
        """Check if the affected asset is VIP or critical infrastructure."""
        data = event.data

        asset_classification = data.get("asset_classification", "").lower()
        if asset_classification not in self.VIP_CLASSIFICATIONS:
            return False

        return True

    def get_command(self, event: TriggerEvent) -> str:
        """Generate the /assess-vuln command with VIP priority."""
        cve_id = event.data.get("cve_id", "unknown")
        affected_assets = event.data.get("affected_assets", [])
        classification = event.data.get("asset_classification", "vip")

        assets_str = ",".join(affected_assets) if affected_assets else "unknown"
        return f"/assess-vuln {cve_id} --vip --assets {assets_str} --classification {classification}"
