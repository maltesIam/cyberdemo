"""Trigger handler for exploit availability."""

from typing import Optional
from ..base import BaseTriggerHandler, TriggerEvent
from ..gateway_client import GatewayClient


class ExploitAvailableTrigger(BaseTriggerHandler):
    """Trigger that fires when an exploit becomes available for a known vulnerability.

    This trigger monitors for new exploit code availability (PoC or weaponized)
    affecting assets in the organization.
    """

    def __init__(self, gateway_client: Optional[GatewayClient] = None):
        super().__init__(gateway_client)

    @property
    def trigger_name(self) -> str:
        return "exploit_available"

    @property
    def description(self) -> str:
        return "Triggers when a public or weaponized exploit becomes available for a vulnerability"

    @property
    def event_types(self) -> list[str]:
        return ["ctem.exploit.available"]

    def should_trigger(self, event: TriggerEvent) -> bool:
        """Check if there are affected assets."""
        data = event.data

        # Only trigger if we have affected assets
        affected_assets = data.get("affected_assets", [])
        if not affected_assets:
            return False

        return True

    def get_command(self, event: TriggerEvent) -> str:
        """Generate the /assess-vuln command for exploit availability."""
        cve_id = event.data.get("cve_id", "unknown")
        exploit_type = event.data.get("exploit_type", "unknown")
        exploit_maturity = event.data.get("exploit_maturity", "unknown")
        affected_assets = event.data.get("affected_assets", [])
        asset_count = len(affected_assets)

        return f"/assess-vuln {cve_id} --exploit-available --type {exploit_type} --maturity {exploit_maturity} --affected-count {asset_count}"
