"""
Unit tests for MalwareBazaar API Client.

MalwareBazaar (abuse.ch) provides malware sample intelligence including
file hashes, signatures, and tags.

API Documentation: https://bazaar.abuse.ch/api/
Free, unlimited API.

These tests are written FIRST following TDD.
"""

import pytest
from unittest.mock import AsyncMock, patch, MagicMock
import httpx


class TestMalwareBazaarClient:
    """Unit tests for MalwareBazaarClient."""

    @pytest.mark.asyncio
    async def test_malwarebazaar_query_hash_returns_data(self):
        """
        RED: Test that MalwareBazaarClient can query a hash and return data.

        The API returns malware sample information when querying by hash.
        """
        from src.clients.malwarebazaar_client import MalwareBazaarClient

        client = MalwareBazaarClient()

        # Mock successful response
        mock_response = MagicMock()
        mock_response.status_code = 200
        mock_response.json.return_value = {
            "query_status": "ok",
            "data": [{
                "sha256_hash": "abc123def456789",
                "md5_hash": "def456",
                "sha1_hash": "ghi789",
                "file_type": "exe",
                "file_size": 123456,
                "signature": "Emotet",
                "first_seen": "2023-01-15 10:00:00",
                "last_seen": "2023-06-20 15:30:00",
                "tags": ["Emotet", "Feodo"],
                "intelligence": {
                    "downloads": 1500,
                    "uploads": 25,
                    "clamav": ["Win.Trojan.Emotet"]
                }
            }]
        }

        with patch.object(client.client, 'post', new_callable=AsyncMock) as mock_post:
            mock_post.return_value = mock_response

            result = await client.query_hash("abc123def456789")

        # Assertions
        assert result is not None
        assert "query_status" in result
        assert result["query_status"] == "ok"
        assert "data" in result
        assert len(result["data"]) > 0

        sample = result["data"][0]
        assert "sha256_hash" in sample
        assert "signature" in sample
        assert "file_type" in sample
        assert "tags" in sample

        await client.close()

    @pytest.mark.asyncio
    async def test_malwarebazaar_query_unknown_hash_returns_empty(self):
        """
        RED: Test that querying an unknown hash returns no data.

        The API returns query_status="hash_not_found" for unknown hashes.
        """
        from src.clients.malwarebazaar_client import MalwareBazaarClient

        client = MalwareBazaarClient()

        # Mock response for unknown hash
        mock_response = MagicMock()
        mock_response.status_code = 200
        mock_response.json.return_value = {
            "query_status": "hash_not_found"
        }

        with patch.object(client.client, 'post', new_callable=AsyncMock) as mock_post:
            mock_post.return_value = mock_response

            result = await client.query_hash("nonexistent_hash_12345")

        # Should return result with hash_not_found status
        assert result is not None
        assert result["query_status"] == "hash_not_found"
        assert "data" not in result or result.get("data") is None

        await client.close()

    @pytest.mark.asyncio
    async def test_malwarebazaar_query_by_tag(self):
        """
        RED: Test querying MalwareBazaar by tag.

        The API allows querying samples by tag (e.g., "Emotet", "Cobalt Strike").
        """
        from src.clients.malwarebazaar_client import MalwareBazaarClient

        client = MalwareBazaarClient()

        # Mock successful tag query response
        mock_response = MagicMock()
        mock_response.status_code = 200
        mock_response.json.return_value = {
            "query_status": "ok",
            "data": [
                {
                    "sha256_hash": "sample1_hash",
                    "signature": "Emotet",
                    "tags": ["Emotet", "Banking"],
                    "file_type": "exe"
                },
                {
                    "sha256_hash": "sample2_hash",
                    "signature": "Emotet",
                    "tags": ["Emotet", "Dropper"],
                    "file_type": "dll"
                }
            ]
        }

        with patch.object(client.client, 'post', new_callable=AsyncMock) as mock_post:
            mock_post.return_value = mock_response

            result = await client.query_tag("Emotet")

        # Assertions
        assert result is not None
        assert result["query_status"] == "ok"
        assert "data" in result
        assert len(result["data"]) >= 1

        # Verify all samples have the queried tag
        for sample in result["data"]:
            assert "tags" in sample

        await client.close()

    @pytest.mark.asyncio
    async def test_malwarebazaar_query_by_signature(self):
        """
        RED: Test querying MalwareBazaar by signature name.

        The API allows querying samples by malware signature/family name.
        """
        from src.clients.malwarebazaar_client import MalwareBazaarClient

        client = MalwareBazaarClient()

        # Mock successful signature query response
        mock_response = MagicMock()
        mock_response.status_code = 200
        mock_response.json.return_value = {
            "query_status": "ok",
            "data": [
                {
                    "sha256_hash": "cobalt_sample1",
                    "signature": "CobaltStrike",
                    "file_type": "exe",
                    "first_seen": "2024-01-10 08:00:00"
                }
            ]
        }

        with patch.object(client.client, 'post', new_callable=AsyncMock) as mock_post:
            mock_post.return_value = mock_response

            result = await client.query_signature("CobaltStrike")

        # Assertions
        assert result is not None
        assert result["query_status"] == "ok"
        assert "data" in result
        assert len(result["data"]) >= 1

        # Verify signature matches
        for sample in result["data"]:
            assert "signature" in sample

        await client.close()

    @pytest.mark.asyncio
    async def test_malwarebazaar_handles_api_error(self):
        """
        RED: Test that client handles API errors gracefully.

        Should return None on server errors (5xx) or other failures.
        """
        from src.clients.malwarebazaar_client import MalwareBazaarClient

        client = MalwareBazaarClient()

        # Mock server error
        mock_response = MagicMock()
        mock_response.status_code = 500
        mock_response.text = "Internal Server Error"

        with patch.object(client.client, 'post', new_callable=AsyncMock) as mock_post:
            mock_post.return_value = mock_response

            result = await client.query_hash("some_hash")

        # Should return None on API error
        assert result is None

        await client.close()

    @pytest.mark.asyncio
    async def test_malwarebazaar_handles_timeout(self):
        """
        RED: Test that client handles timeout gracefully.
        """
        from src.clients.malwarebazaar_client import MalwareBazaarClient

        client = MalwareBazaarClient(timeout=5)

        with patch.object(client.client, 'post', new_callable=AsyncMock) as mock_post:
            mock_post.side_effect = httpx.TimeoutException("Request timed out")

            result = await client.query_hash("some_hash")

        # Should return None on timeout
        assert result is None

        await client.close()

    @pytest.mark.asyncio
    async def test_malwarebazaar_handles_network_error(self):
        """
        RED: Test that client handles network errors gracefully.
        """
        from src.clients.malwarebazaar_client import MalwareBazaarClient

        client = MalwareBazaarClient()

        with patch.object(client.client, 'post', new_callable=AsyncMock) as mock_post:
            mock_post.side_effect = httpx.RequestError("Connection failed")

            result = await client.query_hash("some_hash")

        # Should return None on network error
        assert result is None

        await client.close()

    @pytest.mark.asyncio
    async def test_malwarebazaar_sends_correct_form_data_for_hash(self):
        """
        RED: Test that client sends correct form-encoded data for hash query.

        MalwareBazaar expects POST with form-encoded data:
        - query=get_info
        - hash=<sha256>
        """
        from src.clients.malwarebazaar_client import MalwareBazaarClient

        client = MalwareBazaarClient()

        mock_response = MagicMock()
        mock_response.status_code = 200
        mock_response.json.return_value = {"query_status": "ok", "data": []}

        with patch.object(client.client, 'post', new_callable=AsyncMock) as mock_post:
            mock_post.return_value = mock_response

            await client.query_hash("abc123hash")

            # Verify correct form data was sent
            mock_post.assert_called_once()
            call_args = mock_post.call_args

            # Check URL
            assert "mb-api.abuse.ch" in call_args.args[0]

            # Check form data
            data = call_args.kwargs.get('data', {})
            assert data.get('query') == 'get_info'
            assert data.get('hash') == 'abc123hash'

        await client.close()

    @pytest.mark.asyncio
    async def test_malwarebazaar_sends_correct_form_data_for_tag(self):
        """
        RED: Test that client sends correct form-encoded data for tag query.
        """
        from src.clients.malwarebazaar_client import MalwareBazaarClient

        client = MalwareBazaarClient()

        mock_response = MagicMock()
        mock_response.status_code = 200
        mock_response.json.return_value = {"query_status": "ok", "data": []}

        with patch.object(client.client, 'post', new_callable=AsyncMock) as mock_post:
            mock_post.return_value = mock_response

            await client.query_tag("Emotet")

            # Verify correct form data was sent
            mock_post.assert_called_once()
            call_args = mock_post.call_args

            data = call_args.kwargs.get('data', {})
            assert data.get('query') == 'get_taginfo'
            assert data.get('tag') == 'Emotet'

        await client.close()

    @pytest.mark.asyncio
    async def test_malwarebazaar_sends_correct_form_data_for_signature(self):
        """
        RED: Test that client sends correct form-encoded data for signature query.
        """
        from src.clients.malwarebazaar_client import MalwareBazaarClient

        client = MalwareBazaarClient()

        mock_response = MagicMock()
        mock_response.status_code = 200
        mock_response.json.return_value = {"query_status": "ok", "data": []}

        with patch.object(client.client, 'post', new_callable=AsyncMock) as mock_post:
            mock_post.return_value = mock_response

            await client.query_signature("CobaltStrike")

            # Verify correct form data was sent
            mock_post.assert_called_once()
            call_args = mock_post.call_args

            data = call_args.kwargs.get('data', {})
            assert data.get('query') == 'get_siginfo'
            assert data.get('signature') == 'CobaltStrike'

        await client.close()

    @pytest.mark.asyncio
    async def test_malwarebazaar_handles_illegal_hash(self):
        """
        RED: Test handling of illegal/invalid hash format.

        The API returns query_status="illegal_hash" for malformed hashes.
        """
        from src.clients.malwarebazaar_client import MalwareBazaarClient

        client = MalwareBazaarClient()

        mock_response = MagicMock()
        mock_response.status_code = 200
        mock_response.json.return_value = {
            "query_status": "illegal_hash"
        }

        with patch.object(client.client, 'post', new_callable=AsyncMock) as mock_post:
            mock_post.return_value = mock_response

            result = await client.query_hash("invalid!")

        # Should return the response with illegal_hash status
        assert result is not None
        assert result["query_status"] == "illegal_hash"

        await client.close()

    @pytest.mark.asyncio
    async def test_malwarebazaar_handles_no_results_for_tag(self):
        """
        RED: Test handling when tag query returns no results.
        """
        from src.clients.malwarebazaar_client import MalwareBazaarClient

        client = MalwareBazaarClient()

        mock_response = MagicMock()
        mock_response.status_code = 200
        mock_response.json.return_value = {
            "query_status": "no_results"
        }

        with patch.object(client.client, 'post', new_callable=AsyncMock) as mock_post:
            mock_post.return_value = mock_response

            result = await client.query_tag("NonExistentTag12345")

        assert result is not None
        assert result["query_status"] == "no_results"

        await client.close()
