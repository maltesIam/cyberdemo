"""
MCP Vulnerability Enrichment Tools Tests.

Tests the MCP tools for vulnerability enrichment that enable AI agents
to enrich CVEs with vulnerability intelligence.

Tools tested:
- vuln_enrich_cve: Enrich CVEs with vulnerability intel
- vuln_get_ssvc_decision: Get SSVC classification
- vuln_search: Search enriched vulnerabilities
- vuln_get_risk_assessment: Get composite risk score
"""

import pytest
from typing import Any, Dict
from unittest.mock import AsyncMock, patch, MagicMock


class TestMCPVulnerabilityToolRegistration:
    """Tests for MCP vulnerability tool registration."""

    def test_mcp_vuln_enrich_cve_tool_exists(self):
        """
        GIVEN the MCP tools registry
        WHEN we get all tools
        THEN vuln_enrich_cve tool should be registered
        """
        from src.mcp.tools import get_all_tools

        tools = get_all_tools()
        tool_names = {t["name"] for t in tools}

        assert "vuln_enrich_cve" in tool_names, "vuln_enrich_cve tool should be registered"

    def test_mcp_vuln_get_ssvc_decision_tool_exists(self):
        """
        GIVEN the MCP tools registry
        WHEN we get all tools
        THEN vuln_get_ssvc_decision tool should be registered
        """
        from src.mcp.tools import get_all_tools

        tools = get_all_tools()
        tool_names = {t["name"] for t in tools}

        assert "vuln_get_ssvc_decision" in tool_names, "vuln_get_ssvc_decision tool should be registered"

    def test_mcp_vuln_search_tool_exists(self):
        """
        GIVEN the MCP tools registry
        WHEN we get all tools
        THEN vuln_search tool should be registered
        """
        from src.mcp.tools import get_all_tools

        tools = get_all_tools()
        tool_names = {t["name"] for t in tools}

        assert "vuln_search" in tool_names, "vuln_search tool should be registered"

    def test_mcp_vuln_get_risk_assessment_tool_exists(self):
        """
        GIVEN the MCP tools registry
        WHEN we get all tools
        THEN vuln_get_risk_assessment tool should be registered
        """
        from src.mcp.tools import get_all_tools

        tools = get_all_tools()
        tool_names = {t["name"] for t in tools}

        assert "vuln_get_risk_assessment" in tool_names, "vuln_get_risk_assessment tool should be registered"


class TestMCPVulnerabilityToolSchemas:
    """Tests for MCP vulnerability tool schemas."""

    def test_vuln_enrich_cve_has_valid_schema(self):
        """
        GIVEN the vuln_enrich_cve tool
        WHEN we inspect its schema
        THEN it should have proper inputSchema with cve_ids field
        """
        from src.mcp.tools import get_all_tools

        tools = get_all_tools()
        tool = next((t for t in tools if t["name"] == "vuln_enrich_cve"), None)

        assert tool is not None, "vuln_enrich_cve tool not found"
        assert "inputSchema" in tool, "Tool should have inputSchema"
        assert "properties" in tool["inputSchema"], "Schema should have properties"
        assert "cve_ids" in tool["inputSchema"]["properties"], "Schema should have cve_ids property"
        assert "required" in tool["inputSchema"], "Schema should have required fields"
        assert "cve_ids" in tool["inputSchema"]["required"], "cve_ids should be required"

    def test_vuln_get_ssvc_decision_has_valid_schema(self):
        """
        GIVEN the vuln_get_ssvc_decision tool
        WHEN we inspect its schema
        THEN it should have proper inputSchema with cve_id field
        """
        from src.mcp.tools import get_all_tools

        tools = get_all_tools()
        tool = next((t for t in tools if t["name"] == "vuln_get_ssvc_decision"), None)

        assert tool is not None, "vuln_get_ssvc_decision tool not found"
        assert "inputSchema" in tool, "Tool should have inputSchema"
        assert "properties" in tool["inputSchema"], "Schema should have properties"
        assert "cve_id" in tool["inputSchema"]["properties"], "Schema should have cve_id property"

    def test_vuln_search_has_valid_schema(self):
        """
        GIVEN the vuln_search tool
        WHEN we inspect its schema
        THEN it should have proper inputSchema with filter fields
        """
        from src.mcp.tools import get_all_tools

        tools = get_all_tools()
        tool = next((t for t in tools if t["name"] == "vuln_search"), None)

        assert tool is not None, "vuln_search tool not found"
        assert "inputSchema" in tool, "Tool should have inputSchema"
        assert "properties" in tool["inputSchema"], "Schema should have properties"

        # Verify key filter properties
        props = tool["inputSchema"]["properties"]
        assert "ssvc_decision" in props, "Schema should have ssvc_decision filter"
        assert "risk_level" in props, "Schema should have risk_level filter"
        assert "is_kev" in props, "Schema should have is_kev filter"

    def test_vuln_get_risk_assessment_has_valid_schema(self):
        """
        GIVEN the vuln_get_risk_assessment tool
        WHEN we inspect its schema
        THEN it should have proper inputSchema with cve_id field
        """
        from src.mcp.tools import get_all_tools

        tools = get_all_tools()
        tool = next((t for t in tools if t["name"] == "vuln_get_risk_assessment"), None)

        assert tool is not None, "vuln_get_risk_assessment tool not found"
        assert "inputSchema" in tool, "Tool should have inputSchema"
        assert "properties" in tool["inputSchema"], "Schema should have properties"
        assert "cve_id" in tool["inputSchema"]["properties"], "Schema should have cve_id property"


class TestMCPVulnerabilityHandlers:
    """Tests for MCP vulnerability tool handlers."""

    def test_vuln_enrich_cve_handler_exists(self):
        """
        GIVEN the MCP tools registry
        WHEN we get tool handlers
        THEN vuln_enrich_cve handler should be registered
        """
        from src.mcp.tools import get_tool_handlers

        handlers = get_tool_handlers()
        assert "vuln_enrich_cve" in handlers, "vuln_enrich_cve handler should be registered"

    def test_vuln_get_ssvc_decision_handler_exists(self):
        """
        GIVEN the MCP tools registry
        WHEN we get tool handlers
        THEN vuln_get_ssvc_decision handler should be registered
        """
        from src.mcp.tools import get_tool_handlers

        handlers = get_tool_handlers()
        assert "vuln_get_ssvc_decision" in handlers, "vuln_get_ssvc_decision handler should be registered"

    def test_vuln_search_handler_exists(self):
        """
        GIVEN the MCP tools registry
        WHEN we get tool handlers
        THEN vuln_search handler should be registered
        """
        from src.mcp.tools import get_tool_handlers

        handlers = get_tool_handlers()
        assert "vuln_search" in handlers, "vuln_search handler should be registered"

    def test_vuln_get_risk_assessment_handler_exists(self):
        """
        GIVEN the MCP tools registry
        WHEN we get tool handlers
        THEN vuln_get_risk_assessment handler should be registered
        """
        from src.mcp.tools import get_tool_handlers

        handlers = get_tool_handlers()
        assert "vuln_get_risk_assessment" in handlers, "vuln_get_risk_assessment handler should be registered"


class TestMCPVulnEnrichCVEHandler:
    """Tests for vuln_enrich_cve handler."""

    @pytest.mark.asyncio
    async def test_enrich_cve_returns_valid_schema(self):
        """
        GIVEN the vuln_enrich_cve handler
        WHEN called with valid CVE IDs
        THEN it should return enriched data with proper schema
        """
        from src.mcp.tools.vulnerability import handle_vuln_enrich_cve

        # Mock the VulnerabilityEnrichmentService
        mock_result = {
            "job_id": "test-job-123",
            "total_items": 1,
            "enriched_cves": [
                {
                    "cve_id": "CVE-2024-1234",
                    "cvss_v3_score": 9.8,
                    "epss_score": 0.95,
                    "is_kev": True
                }
            ],
            "sources": {"nvd": {"status": "success", "enriched_count": 1}},
            "successful_sources": 1,
            "failed_sources": 0,
            "errors": []
        }

        with patch("src.services.vuln_enrichment_service.VulnerabilityEnrichmentService") as MockService:
            mock_instance = AsyncMock()
            mock_instance.enrich_vulnerabilities.return_value = mock_result
            MockService.return_value = mock_instance

            result = await handle_vuln_enrich_cve({
                "cve_ids": ["CVE-2024-1234"]
            })

        # Verify result structure
        assert isinstance(result, dict), "Result should be a dict"
        assert "job_id" in result, "Result should have job_id"
        assert "enriched_cves" in result, "Result should have enriched_cves"

    @pytest.mark.asyncio
    async def test_enrich_cve_validates_cve_ids(self):
        """
        GIVEN the vuln_enrich_cve handler
        WHEN called with empty cve_ids
        THEN it should raise ValueError
        """
        from src.mcp.tools import get_tool_handlers

        handlers = get_tool_handlers()
        handler = handlers["vuln_enrich_cve"]

        with pytest.raises(ValueError) as exc_info:
            await handler({"cve_ids": []})

        assert "empty" in str(exc_info.value).lower()

    @pytest.mark.asyncio
    async def test_enrich_cve_validates_cve_format(self):
        """
        GIVEN the vuln_enrich_cve handler
        WHEN called with invalid CVE format
        THEN it should raise ValueError
        """
        from src.mcp.tools import get_tool_handlers

        handlers = get_tool_handlers()
        handler = handlers["vuln_enrich_cve"]

        with pytest.raises(ValueError) as exc_info:
            await handler({"cve_ids": ["INVALID-ID"]})

        assert "invalid" in str(exc_info.value).lower() or "cve" in str(exc_info.value).lower()

    @pytest.mark.asyncio
    async def test_enrich_cve_limits_to_100(self):
        """
        GIVEN the vuln_enrich_cve handler
        WHEN called with more than 100 CVE IDs
        THEN it should raise ValueError
        """
        from src.mcp.tools import get_tool_handlers

        handlers = get_tool_handlers()
        handler = handlers["vuln_enrich_cve"]

        cve_ids = [f"CVE-2024-{i:04d}" for i in range(150)]

        with pytest.raises(ValueError) as exc_info:
            await handler({"cve_ids": cve_ids})

        assert "100" in str(exc_info.value)


class TestMCPVulnSearchHandler:
    """Tests for vuln_search handler."""

    @pytest.mark.asyncio
    async def test_vuln_search_returns_valid_schema(self):
        """
        GIVEN the vuln_search handler
        WHEN called with filters
        THEN it should return matching vulnerabilities with proper schema
        """
        from src.mcp.tools import get_tool_handlers

        handlers = get_tool_handlers()
        handler = handlers["vuln_search"]

        result = await handler({
            "risk_level": "Critical",
            "limit": 10
        })

        # Verify result structure
        assert isinstance(result, dict), "Result should be a dict"
        assert "vulnerabilities" in result, "Result should have vulnerabilities"
        assert "total_count" in result, "Result should have total_count"
        assert "filters_applied" in result, "Result should have filters_applied"
        assert isinstance(result["vulnerabilities"], list), "vulnerabilities should be a list"

    @pytest.mark.asyncio
    async def test_vuln_search_with_ssvc_filter(self):
        """
        GIVEN the vuln_search handler
        WHEN called with SSVC decision filter
        THEN it should return only matching vulnerabilities
        """
        from src.mcp.tools import get_tool_handlers

        handlers = get_tool_handlers()
        handler = handlers["vuln_search"]

        result = await handler({
            "ssvc_decision": "Act"
        })

        # Verify all results have matching SSVC decision
        for vuln in result["vulnerabilities"]:
            assert vuln["ssvc_decision"] == "Act", "All results should have Act SSVC"

    @pytest.mark.asyncio
    async def test_vuln_search_with_kev_filter(self):
        """
        GIVEN the vuln_search handler
        WHEN called with is_kev=True filter
        THEN it should return only KEV vulnerabilities
        """
        from src.mcp.tools import get_tool_handlers

        handlers = get_tool_handlers()
        handler = handlers["vuln_search"]

        result = await handler({
            "is_kev": True
        })

        # Verify all results are in KEV
        for vuln in result["vulnerabilities"]:
            assert vuln["is_kev"] is True, "All results should be in KEV"

    @pytest.mark.asyncio
    async def test_vuln_search_respects_limit(self):
        """
        GIVEN the vuln_search handler
        WHEN called with a limit
        THEN it should return at most that many results
        """
        from src.mcp.tools import get_tool_handlers

        handlers = get_tool_handlers()
        handler = handlers["vuln_search"]

        result = await handler({
            "limit": 5
        })

        assert len(result["vulnerabilities"]) <= 5, "Should respect limit"


class TestMCPVulnSSVCDecisionHandler:
    """Tests for vuln_get_ssvc_decision handler."""

    @pytest.mark.asyncio
    async def test_ssvc_decision_returns_valid_schema(self):
        """
        GIVEN the vuln_get_ssvc_decision handler
        WHEN called with a CVE ID and enrichment data
        THEN it should return SSVC decision with proper schema
        """
        from src.mcp.tools import get_tool_handlers

        handlers = get_tool_handlers()
        handler = handlers["vuln_get_ssvc_decision"]

        result = await handler({
            "cve_id": "CVE-2024-1234",
            "is_kev": True,
            "epss_score": 0.95,
            "cvss_v3_score": 9.8,
            "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
            "exploit_count": 5
        })

        # Verify result structure
        assert isinstance(result, dict), "Result should be a dict"
        assert "cve_id" in result, "Result should have cve_id"
        assert "ssvc_decision" in result, "Result should have ssvc_decision"
        assert "exploitation_status" in result, "Result should have exploitation_status"
        assert "automatable" in result, "Result should have automatable"
        assert "technical_impact" in result, "Result should have technical_impact"

    @pytest.mark.asyncio
    async def test_ssvc_decision_requires_cve_id(self):
        """
        GIVEN the vuln_get_ssvc_decision handler
        WHEN called without cve_id
        THEN it should raise ValueError
        """
        from src.mcp.tools import get_tool_handlers

        handlers = get_tool_handlers()
        handler = handlers["vuln_get_ssvc_decision"]

        with pytest.raises(ValueError) as exc_info:
            await handler({})

        assert "cve_id" in str(exc_info.value).lower()

    @pytest.mark.asyncio
    async def test_ssvc_decision_kev_returns_act_or_attend(self):
        """
        GIVEN the vuln_get_ssvc_decision handler
        WHEN called with is_kev=True
        THEN it should return Act or Attend (active exploitation)
        """
        from src.mcp.tools import get_tool_handlers

        handlers = get_tool_handlers()
        handler = handlers["vuln_get_ssvc_decision"]

        result = await handler({
            "cve_id": "CVE-2024-1234",
            "is_kev": True,
            "epss_score": 0.5,
            "cvss_v3_score": 9.0,
            "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"
        })

        # KEV = active exploitation = Act or Attend
        assert result["ssvc_decision"] in ["Act", "Attend"], "KEV should result in Act or Attend"
        assert result["exploitation_status"] == "active", "KEV should be active exploitation"


class TestMCPVulnRiskAssessmentHandler:
    """Tests for vuln_get_risk_assessment handler."""

    @pytest.mark.asyncio
    async def test_risk_assessment_returns_valid_schema(self):
        """
        GIVEN the vuln_get_risk_assessment handler
        WHEN called with CVE data
        THEN it should return risk score with proper schema
        """
        from src.mcp.tools import get_tool_handlers

        handlers = get_tool_handlers()
        handler = handlers["vuln_get_risk_assessment"]

        result = await handler({
            "cve_id": "CVE-2024-1234",
            "cvss_v3_score": 9.8,
            "epss_score": 0.95,
            "is_kev": True,
            "exploit_maturity": "weaponized"
        })

        # Verify result structure
        assert isinstance(result, dict), "Result should be a dict"
        assert "cve_id" in result, "Result should have cve_id"
        assert "risk_score" in result, "Result should have risk_score"
        assert "risk_level" in result, "Result should have risk_level"
        assert "components" in result, "Result should have components breakdown"

    @pytest.mark.asyncio
    async def test_risk_assessment_requires_cve_id(self):
        """
        GIVEN the vuln_get_risk_assessment handler
        WHEN called without cve_id
        THEN it should raise ValueError
        """
        from src.mcp.tools import get_tool_handlers

        handlers = get_tool_handlers()
        handler = handlers["vuln_get_risk_assessment"]

        with pytest.raises(ValueError) as exc_info:
            await handler({})

        assert "cve_id" in str(exc_info.value).lower()

    @pytest.mark.asyncio
    async def test_risk_assessment_score_range(self):
        """
        GIVEN the vuln_get_risk_assessment handler
        WHEN called with CVE data
        THEN risk_score should be between 0 and 100
        """
        from src.mcp.tools import get_tool_handlers

        handlers = get_tool_handlers()
        handler = handlers["vuln_get_risk_assessment"]

        result = await handler({
            "cve_id": "CVE-2024-1234",
            "cvss_v3_score": 9.8,
            "epss_score": 0.95,
            "is_kev": True,
            "exploit_maturity": "weaponized"
        })

        assert 0 <= result["risk_score"] <= 100, "Risk score should be 0-100"

    @pytest.mark.asyncio
    async def test_risk_assessment_critical_level(self):
        """
        GIVEN the vuln_get_risk_assessment handler
        WHEN called with high-risk CVE data
        THEN risk_level should be Critical
        """
        from src.mcp.tools import get_tool_handlers

        handlers = get_tool_handlers()
        handler = handlers["vuln_get_risk_assessment"]

        result = await handler({
            "cve_id": "CVE-2024-1234",
            "cvss_v3_score": 10.0,
            "epss_score": 1.0,
            "is_kev": True,
            "exploit_maturity": "weaponized",
            "shodan_exposed_count": 1000
        })

        assert result["risk_level"] == "Critical", "High-risk CVE should be Critical"


class TestMCPVulnerabilityIntegration:
    """Integration tests for MCP vulnerability tools with the server."""

    def test_all_vulnerability_tools_registered(self):
        """
        GIVEN the MCP tools registry
        WHEN we get all tools
        THEN all 4 vulnerability tools should be registered
        """
        from src.mcp.tools import get_all_tools

        tools = get_all_tools()
        tool_names = {t["name"] for t in tools}

        expected_tools = {
            "vuln_enrich_cve",
            "vuln_get_ssvc_decision",
            "vuln_search",
            "vuln_get_risk_assessment"
        }

        for tool_name in expected_tools:
            assert tool_name in tool_names, f"{tool_name} should be registered"

    def test_all_vulnerability_handlers_registered(self):
        """
        GIVEN the MCP tools registry
        WHEN we get all handlers
        THEN all 4 vulnerability handlers should be registered
        """
        from src.mcp.tools import get_tool_handlers

        handlers = get_tool_handlers()

        expected_handlers = [
            "vuln_enrich_cve",
            "vuln_get_ssvc_decision",
            "vuln_search",
            "vuln_get_risk_assessment"
        ]

        for handler_name in expected_handlers:
            assert handler_name in handlers, f"{handler_name} handler should be registered"
            assert callable(handlers[handler_name]), f"{handler_name} should be callable"

    def test_tools_have_descriptions(self):
        """
        GIVEN the MCP vulnerability tools
        WHEN we inspect each tool
        THEN each should have a non-empty description
        """
        from src.mcp.tools import get_all_tools

        tools = get_all_tools()
        vuln_tools = [t for t in tools if t["name"].startswith("vuln_")]

        for tool in vuln_tools:
            assert "description" in tool, f"{tool['name']} should have description"
            assert len(tool["description"]) > 10, f"{tool['name']} description too short"
